<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Oadr20bVTNEiReportService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">OpenADRServerVTN20b</a> &gt; <a href="index.source.html" class="el_package">com.avob.openadr.server.oadr20b.vtn.service</a> &gt; <span class="el_source">Oadr20bVTNEiReportService.java</span></div><h1>Oadr20bVTNEiReportService.java</h1><pre class="source lang-java linenums">package com.avob.openadr.server.oadr20b.vtn.service;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.List;
import java.util.Map;
import java.util.UUID;
import java.util.stream.Collectors;

import javax.annotation.Resource;
import javax.xml.bind.JAXBElement;
import javax.xml.bind.JAXBException;

import org.eclipse.jetty.http.HttpStatus;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import com.avob.openadr.model.oadr20b.Oadr20bFactory;
import com.avob.openadr.model.oadr20b.Oadr20bJAXBContext;
import com.avob.openadr.model.oadr20b.builders.Oadr20bEiReportBuilders;
import com.avob.openadr.model.oadr20b.builders.Oadr20bResponseBuilders;
import com.avob.openadr.model.oadr20b.builders.eireport.Oadr20bCreateReportBuilder;
import com.avob.openadr.model.oadr20b.builders.eireport.Oadr20bReportRequestTypeBuilder;
import com.avob.openadr.model.oadr20b.ei.EiResponseType;
import com.avob.openadr.model.oadr20b.ei.IntervalType;
import com.avob.openadr.model.oadr20b.ei.PayloadBaseType;
import com.avob.openadr.model.oadr20b.ei.PayloadFloatType;
import com.avob.openadr.model.oadr20b.ei.ReadingTypeEnumeratedType;
import com.avob.openadr.model.oadr20b.ei.ReportEnumeratedType;
import com.avob.openadr.model.oadr20b.ei.ReportNameEnumeratedType;
import com.avob.openadr.model.oadr20b.ei.ReportSpecifierType;
import com.avob.openadr.model.oadr20b.ei.SpecifierPayloadType;
import com.avob.openadr.model.oadr20b.emix.ItemBaseType;
import com.avob.openadr.model.oadr20b.exception.Oadr20bMarshalException;
import com.avob.openadr.model.oadr20b.exception.Oadr20bUnmarshalException;
import com.avob.openadr.model.oadr20b.exception.Oadr20bXMLSignatureException;
import com.avob.openadr.model.oadr20b.oadr.BaseUnitType;
import com.avob.openadr.model.oadr20b.oadr.CurrencyType;
import com.avob.openadr.model.oadr20b.oadr.CurrentType;
import com.avob.openadr.model.oadr20b.oadr.FrequencyType;
import com.avob.openadr.model.oadr20b.oadr.OadrCancelReportType;
import com.avob.openadr.model.oadr20b.oadr.OadrCanceledReportType;
import com.avob.openadr.model.oadr20b.oadr.OadrCreateReportType;
import com.avob.openadr.model.oadr20b.oadr.OadrCreatedReportType;
import com.avob.openadr.model.oadr20b.oadr.OadrGBItemBase;
import com.avob.openadr.model.oadr20b.oadr.OadrLoadControlStateTypeType;
import com.avob.openadr.model.oadr20b.oadr.OadrPayloadResourceStatusType;
import com.avob.openadr.model.oadr20b.oadr.OadrRegisterReportType;
import com.avob.openadr.model.oadr20b.oadr.OadrRegisteredReportType;
import com.avob.openadr.model.oadr20b.oadr.OadrReportDescriptionType;
import com.avob.openadr.model.oadr20b.oadr.OadrReportPayloadType;
import com.avob.openadr.model.oadr20b.oadr.OadrReportRequestType;
import com.avob.openadr.model.oadr20b.oadr.OadrReportType;
import com.avob.openadr.model.oadr20b.oadr.OadrResponseType;
import com.avob.openadr.model.oadr20b.oadr.OadrSamplingRateType;
import com.avob.openadr.model.oadr20b.oadr.OadrUpdateReportType;
import com.avob.openadr.model.oadr20b.oadr.OadrUpdatedReportType;
import com.avob.openadr.model.oadr20b.oadr.PulseCountType;
import com.avob.openadr.model.oadr20b.oadr.TemperatureType;
import com.avob.openadr.model.oadr20b.oadr.ThermType;
import com.avob.openadr.model.oadr20b.power.EnergyApparentType;
import com.avob.openadr.model.oadr20b.power.EnergyReactiveType;
import com.avob.openadr.model.oadr20b.power.EnergyRealType;
import com.avob.openadr.model.oadr20b.power.PowerApparentType;
import com.avob.openadr.model.oadr20b.power.PowerReactiveType;
import com.avob.openadr.model.oadr20b.power.PowerRealType;
import com.avob.openadr.model.oadr20b.power.VoltageType;
import com.avob.openadr.model.oadr20b.siscale.SiScaleCodeType;
import com.avob.openadr.model.oadr20b.strm.Intervals;
import com.avob.openadr.model.oadr20b.strm.StreamPayloadBaseType;
import com.avob.openadr.model.oadr20b.xcal.Dtstart;
import com.avob.openadr.model.oadr20b.xcal.DurationPropType;
import com.avob.openadr.model.oadr20b.xcal.Properties;
import com.avob.openadr.model.oadr20b.xcal.WsCalendarIntervalType;
import com.avob.openadr.server.common.vtn.exception.OadrVTNInitializationException;
import com.avob.openadr.server.common.vtn.models.ven.Ven;
import com.avob.openadr.server.common.vtn.models.venmarketcontext.VenMarketContext;
import com.avob.openadr.server.common.vtn.service.VenMarketContextService;
import com.avob.openadr.server.common.vtn.service.VenService;
import com.avob.openadr.server.oadr20b.vtn.exception.OadrElementNotFoundException;
import com.avob.openadr.server.oadr20b.vtn.exception.eireport.Oadr20bCancelReportApplicationLayerException;
import com.avob.openadr.server.oadr20b.vtn.exception.eireport.Oadr20bCreateReportApplicationLayerException;
import com.avob.openadr.server.oadr20b.vtn.exception.eireport.Oadr20bCreatedReportApplicationLayerException;
import com.avob.openadr.server.oadr20b.vtn.exception.eireport.Oadr20bRegisterReportApplicationLayerException;
import com.avob.openadr.server.oadr20b.vtn.exception.eireport.Oadr20bUpdateReportApplicationLayerException;
import com.avob.openadr.server.oadr20b.vtn.models.venreport.capability.OtherReportCapability;
import com.avob.openadr.server.oadr20b.vtn.models.venreport.capability.OtherReportCapabilityDescription;
import com.avob.openadr.server.oadr20b.vtn.models.venreport.capability.SelfReportCapability;
import com.avob.openadr.server.oadr20b.vtn.models.venreport.capability.SelfReportCapabilityDescription;
import com.avob.openadr.server.oadr20b.vtn.models.venreport.data.OtherReportData;
import com.avob.openadr.server.oadr20b.vtn.models.venreport.request.OtherReportRequest;
import com.avob.openadr.server.oadr20b.vtn.models.venreport.request.SelfReportRequest;
import com.avob.openadr.server.oadr20b.vtn.service.report.OtherReportCapabilityDescriptionService;
import com.avob.openadr.server.oadr20b.vtn.service.report.OtherReportCapabilityService;
import com.avob.openadr.server.oadr20b.vtn.service.report.OtherReportDataService;
import com.avob.openadr.server.oadr20b.vtn.service.report.OtherReportRequestService;
import com.avob.openadr.server.oadr20b.vtn.service.report.SelfReportCapabilityDescriptionService;
import com.avob.openadr.server.oadr20b.vtn.service.report.SelfReportCapabilityService;
import com.avob.openadr.server.oadr20b.vtn.service.report.SelfReportRequestService;
import com.google.common.collect.Lists;
import com.google.common.collect.Maps;

@Service
public class Oadr20bVTNEiReportService {

<span class="fc" id="L109">	private static final Logger LOGGER = LoggerFactory.getLogger(Oadr20bVTNEiReportService.class);</span>

	protected static final String METADATA_REPORT_SPECIFIER_ID = &quot;METADATA&quot;;

	protected static final String METADATA_REPORT_RID = &quot;METADATA&quot;;

	protected Oadr20bJAXBContext jaxbContext;

	@Resource
	protected VenService venService;

	@Resource
	protected XmlSignatureService xmlSignatureService;

	@Resource
	protected VenMarketContextService venMarketContextService;

	@Resource
	protected OtherReportCapabilityService otherReportCapabilityService;

	@Resource
	protected OtherReportCapabilityDescriptionService otherReportCapabilityDescriptionService;

	@Resource
	protected OtherReportDataService otherReportDataService;

	@Resource
	protected OtherReportRequestService otherReportRequestService;

	@Resource
	protected SelfReportCapabilityService selfReportCapabilityService;

	@Resource
	protected SelfReportCapabilityDescriptionService selfReportCapabilityDescriptionService;

	@Resource
	protected SelfReportRequestService selfReportRequestService;

	@Resource
	protected VenDistributeService venDistributeService;

	@Value(&quot;${oadr.saveVenData}&quot;)
	private Boolean saveVenData;

<span class="fc" id="L153">	public Oadr20bVTNEiReportService() {</span>
		try {
<span class="fc" id="L155">			jaxbContext = Oadr20bJAXBContext.getInstance();</span>
<span class="nc" id="L156">		} catch (JAXBException e) {</span>
<span class="nc" id="L157">			throw new OadrVTNInitializationException(e);</span>
<span class="fc" id="L158">		}</span>
<span class="fc" id="L159">	}</span>

	/**
	 * Register reporting capabilities
	 * 
	 * from VTN/VEN to VEN/VTN
	 * 
	 * The source party sends its reporting capabilities to the target party. The
	 * source party's reporting capabilities are specified using a special
	 * well-known report profil called the METADATA report, which is exchanged using
	 * the same schema as any other report
	 * 
	 * @param report
	 * @return
	 * @throws Oadr20bXMLSignatureException
	 * @throws Oadr20bMarshalException
	 */
	public String oadrRegisterReport(OadrRegisterReportType payload, boolean signed)
			throws Oadr20bRegisterReportApplicationLayerException, Oadr20bXMLSignatureException,
			Oadr20bMarshalException {

		// String payloadReportRequestID = payload.getReportRequestID();
<span class="fc" id="L181">		String requestID = payload.getRequestID();</span>
<span class="fc" id="L182">		String venID = payload.getVenID();</span>
<span class="fc" id="L183">		Ven ven = venService.findOneByUsername(venID);</span>

<span class="pc bpc" id="L185" title="4 of 6 branches missed.">		if (ven.getXmlSignature() != null &amp;&amp; ven.getXmlSignature() &amp;&amp; !signed) {</span>
<span class="nc" id="L186">			EiResponseType xmlSignatureRequiredButAbsent = Oadr20bResponseBuilders</span>
<span class="nc" id="L187">					.newOadr20bEiResponseXmlSignatureRequiredButAbsentBuilder(requestID, venID).build();</span>
<span class="nc" id="L188">			throw new Oadr20bRegisterReportApplicationLayerException(</span>
<span class="nc" id="L189">					xmlSignatureRequiredButAbsent.getResponseDescription(),</span>
<span class="nc" id="L190">					Oadr20bEiReportBuilders.newOadr20bRegisteredReportBuilder(requestID,</span>
<span class="nc" id="L191">							Integer.valueOf(xmlSignatureRequiredButAbsent.getResponseCode()), venID).build());</span>
		}

<span class="fc" id="L194">		int responseCode = HttpStatus.OK_200;</span>

<span class="fc" id="L196">		List&lt;OtherReportCapability&gt; currentVenCapability = otherReportCapabilityService.findBySource(ven);</span>
<span class="fc" id="L197">		Map&lt;String, OtherReportCapability&gt; currentVenCapabilityMap = currentVenCapability.stream()</span>
<span class="pc" id="L198">				.collect(Collectors.toMap(OtherReportCapability::getReportSpecifierId, cap -&gt; cap));</span>

<span class="fc" id="L200">		List&lt;OtherReportCapabilityDescription&gt; currentVenCapabilityDescription = otherReportCapabilityDescriptionService</span>
<span class="fc" id="L201">				.findByOtherReportCapabilityIn(currentVenCapability);</span>
<span class="fc" id="L202">		Map&lt;String, OtherReportCapabilityDescription&gt; currentVenCapabilityDescriptionMap = currentVenCapabilityDescription</span>
<span class="fc" id="L203">				.stream().collect(Collectors.toMap(</span>
<span class="nc" id="L204">						desc -&gt; desc.getOtherReportCapability().getReportSpecifierId() + desc.getRid(), desc -&gt; desc));</span>

<span class="fc" id="L206">		List&lt;OtherReportCapability&gt; capabilities = Lists.newArrayList();</span>
<span class="fc" id="L207">		List&lt;OtherReportCapabilityDescription&gt; descriptions = Lists.newArrayList();</span>
<span class="fc bfc" id="L208" title="All 2 branches covered.">		for (OadrReportType oadrReportType : payload.getOadrReport()) {</span>

<span class="fc" id="L210">			boolean created = false;</span>
<span class="fc" id="L211">			String reportName = oadrReportType.getReportName();</span>
			// TODO bzanni : reportRequestID = 0 if not yet requested
<span class="fc" id="L213">			String reportRequestID = oadrReportType.getReportRequestID();</span>
<span class="fc" id="L214">			String reportSpecifierID = oadrReportType.getReportSpecifierID();</span>
<span class="fc" id="L215">			DurationPropType duration = oadrReportType.getDuration();</span>

			// OtherReportCapability otherReportCapability = otherReportCapabilityService
			// .findByReportSpecifierId(reportSpecifierID);

<span class="fc" id="L220">			OtherReportCapability otherReportCapability = currentVenCapabilityMap.get(reportSpecifierID);</span>
<span class="pc bpc" id="L221" title="1 of 2 branches missed.">			if (otherReportCapability == null) {</span>
<span class="fc" id="L222">				otherReportCapability = new OtherReportCapability(ven);</span>
<span class="fc" id="L223">				created = true;</span>
			}

<span class="fc" id="L226">			otherReportCapability.setReportName(ReportNameEnumeratedType.fromValue(reportName));</span>
<span class="fc" id="L227">			otherReportCapability.setReportSpecifierId(reportSpecifierID);</span>
<span class="pc bpc" id="L228" title="1 of 2 branches missed.">			if (otherReportCapability.getReportRequestId() == null) {</span>
<span class="fc" id="L229">				otherReportCapability.setReportRequestId(reportRequestID);</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">			} else if (!otherReportCapability.getReportRequestId().equals(reportRequestID)) {</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">				if (&quot;0&quot;.equals(otherReportCapability.getReportRequestId())) {</span>
<span class="nc" id="L232">					otherReportCapability.setReportRequestId(reportRequestID);</span>
				}
			}

<span class="pc bpc" id="L236" title="1 of 2 branches missed.">			if (duration != null) {</span>
<span class="nc" id="L237">				otherReportCapability.setDuration(duration.getDuration());</span>
			}
<span class="fc" id="L239">			capabilities.add(otherReportCapability);</span>
<span class="fc" id="L240">			List&lt;OtherReportCapabilityDescription&gt; capabilityDescription = new ArrayList&lt;OtherReportCapabilityDescription&gt;();</span>
<span class="fc bfc" id="L241" title="All 2 branches covered.">			for (OadrReportDescriptionType oadrReportDescriptionType : oadrReportType.getOadrReportDescription()) {</span>

<span class="fc" id="L243">				String rid = oadrReportDescriptionType.getRID();</span>

<span class="fc" id="L245">				OtherReportCapabilityDescription description = null;</span>
<span class="pc bpc" id="L246" title="1 of 2 branches missed.">				if (!created) {</span>

<span class="nc" id="L248">					currentVenCapabilityDescriptionMap.get(otherReportCapability.getReportSpecifierId() + rid);</span>
				}

<span class="pc bpc" id="L251" title="1 of 2 branches missed.">				if (description == null) {</span>
<span class="fc" id="L252">					description = new OtherReportCapabilityDescription(otherReportCapability);</span>
				}

<span class="fc" id="L255">				String reportType = oadrReportDescriptionType.getReportType();</span>
<span class="fc" id="L256">				String readingType = oadrReportDescriptionType.getReadingType();</span>
<span class="fc" id="L257">				OadrSamplingRateType oadrSamplingRate = oadrReportDescriptionType.getOadrSamplingRate();</span>
<span class="fc" id="L258">				String oadrMaxPeriod = null;</span>
<span class="fc" id="L259">				String oadrMinPeriod = null;</span>
<span class="fc" id="L260">				boolean oadrOnChange = false;</span>
<span class="pc bpc" id="L261" title="1 of 2 branches missed.">				if (oadrSamplingRate != null) {</span>
<span class="fc" id="L262">					oadrMaxPeriod = oadrSamplingRate.getOadrMaxPeriod();</span>
<span class="fc" id="L263">					oadrMinPeriod = oadrSamplingRate.getOadrMinPeriod();</span>
<span class="fc" id="L264">					oadrOnChange = oadrSamplingRate.isOadrOnChange();</span>
				}
<span class="fc" id="L266">				String itemDescription = null;</span>
<span class="fc" id="L267">				String itemUnits = null;</span>
<span class="fc" id="L268">				SiScaleCodeType siScaleCode = null;</span>
<span class="pc bpc" id="L269" title="1 of 2 branches missed.">				if (oadrReportDescriptionType.getItemBase() != null) {</span>
<span class="fc" id="L270">					ItemBaseType value = oadrReportDescriptionType.getItemBase().getValue();</span>
<span class="fc" id="L271">					Class&lt;? extends ItemBaseType&gt; declaredType = oadrReportDescriptionType.getItemBase()</span>
<span class="fc" id="L272">							.getDeclaredType();</span>

<span class="pc bpc" id="L274" title="1 of 2 branches missed.">					if (declaredType.equals(VoltageType.class)) {</span>
<span class="nc" id="L275">						VoltageType el = (VoltageType) value;</span>
<span class="nc" id="L276">						itemDescription = el.getItemDescription();</span>
<span class="nc" id="L277">						itemUnits = el.getItemUnits();</span>
<span class="nc" id="L278">						siScaleCode = el.getSiScaleCode();</span>

<span class="pc bpc" id="L280" title="1 of 2 branches missed.">					} else if (declaredType.equals(EnergyApparentType.class)) {</span>
<span class="nc" id="L281">						EnergyApparentType el = (EnergyApparentType) value;</span>
<span class="nc" id="L282">						itemDescription = el.getItemDescription();</span>
<span class="nc" id="L283">						itemUnits = el.getItemUnits();</span>
<span class="nc" id="L284">						siScaleCode = el.getSiScaleCode();</span>

<span class="pc bpc" id="L286" title="1 of 2 branches missed.">					} else if (declaredType.equals(EnergyReactiveType.class)) {</span>
<span class="nc" id="L287">						EnergyReactiveType el = (EnergyReactiveType) value;</span>
<span class="nc" id="L288">						itemDescription = el.getItemDescription();</span>
<span class="nc" id="L289">						itemUnits = el.getItemUnits();</span>
<span class="nc" id="L290">						siScaleCode = el.getSiScaleCode();</span>

<span class="pc bpc" id="L292" title="1 of 2 branches missed.">					} else if (declaredType.equals(EnergyRealType.class)) {</span>
<span class="nc" id="L293">						EnergyRealType el = (EnergyRealType) value;</span>
<span class="nc" id="L294">						itemDescription = el.getItemDescription();</span>
<span class="nc" id="L295">						itemUnits = el.getItemUnits();</span>
<span class="nc" id="L296">						siScaleCode = el.getSiScaleCode();</span>

<span class="pc bpc" id="L298" title="1 of 2 branches missed.">					} else if (declaredType.equals(PowerApparentType.class)) {</span>
<span class="nc" id="L299">						PowerApparentType el = (PowerApparentType) value;</span>
<span class="nc" id="L300">						itemDescription = el.getItemDescription();</span>
<span class="nc" id="L301">						itemUnits = el.getItemUnits();</span>
<span class="nc" id="L302">						siScaleCode = el.getSiScaleCode();</span>

<span class="pc bpc" id="L304" title="1 of 2 branches missed.">					} else if (declaredType.equals(PowerReactiveType.class)) {</span>
<span class="nc" id="L305">						PowerReactiveType el = (PowerReactiveType) value;</span>
<span class="nc" id="L306">						itemDescription = el.getItemDescription();</span>
<span class="nc" id="L307">						itemUnits = el.getItemUnits();</span>
<span class="nc" id="L308">						siScaleCode = el.getSiScaleCode();</span>

<span class="pc bpc" id="L310" title="1 of 2 branches missed.">					} else if (declaredType.equals(PowerRealType.class)) {</span>
<span class="nc" id="L311">						PowerRealType el = (PowerRealType) value;</span>
<span class="nc" id="L312">						itemDescription = el.getItemDescription();</span>
<span class="nc" id="L313">						itemUnits = el.getItemUnits();</span>
<span class="nc" id="L314">						siScaleCode = el.getSiScaleCode();</span>

<span class="pc bpc" id="L316" title="1 of 2 branches missed.">					} else if (declaredType.equals(BaseUnitType.class)) {</span>
<span class="nc" id="L317">						BaseUnitType el = (BaseUnitType) value;</span>
<span class="nc" id="L318">						itemDescription = el.getItemDescription();</span>
<span class="nc" id="L319">						itemUnits = el.getItemUnits();</span>
<span class="nc" id="L320">						siScaleCode = el.getSiScaleCode();</span>

<span class="pc bpc" id="L322" title="1 of 2 branches missed.">					} else if (declaredType.equals(CurrentType.class)) {</span>
<span class="nc" id="L323">						CurrentType el = (CurrentType) value;</span>
<span class="nc" id="L324">						itemDescription = el.getItemDescription();</span>
<span class="nc" id="L325">						itemUnits = el.getItemUnits();</span>
<span class="nc" id="L326">						siScaleCode = el.getSiScaleCode();</span>

<span class="pc bpc" id="L328" title="1 of 2 branches missed.">					} else if (declaredType.equals(CurrencyType.class)) {</span>
<span class="fc" id="L329">						CurrencyType el = (CurrencyType) value;</span>
<span class="fc" id="L330">						itemDescription = el.getItemDescription().value();</span>
<span class="fc" id="L331">						itemUnits = el.getItemUnits().value();</span>
<span class="fc" id="L332">						siScaleCode = el.getSiScaleCode();</span>

<span class="pc bnc" id="L334" title="All 2 branches missed.">					} else if (declaredType.equals(FrequencyType.class)) {</span>
<span class="nc" id="L335">						FrequencyType el = (FrequencyType) value;</span>
<span class="nc" id="L336">						itemDescription = el.getItemDescription();</span>
<span class="nc" id="L337">						itemUnits = el.getItemUnits();</span>
<span class="nc" id="L338">						siScaleCode = el.getSiScaleCode();</span>

<span class="nc bnc" id="L340" title="All 2 branches missed.">					} else if (declaredType.equals(ThermType.class)) {</span>
<span class="nc" id="L341">						ThermType el = (ThermType) value;</span>
<span class="nc" id="L342">						itemDescription = el.getItemDescription();</span>
<span class="nc" id="L343">						itemUnits = el.getItemUnits();</span>
<span class="nc" id="L344">						siScaleCode = el.getSiScaleCode();</span>

<span class="nc bnc" id="L346" title="All 2 branches missed.">					} else if (declaredType.equals(TemperatureType.class)) {</span>
<span class="nc" id="L347">						TemperatureType el = (TemperatureType) value;</span>
<span class="nc" id="L348">						itemDescription = el.getItemDescription();</span>
<span class="nc" id="L349">						itemUnits = el.getItemUnits().value();</span>
<span class="nc" id="L350">						siScaleCode = el.getSiScaleCode();</span>

<span class="nc bnc" id="L352" title="All 2 branches missed.">					} else if (declaredType.equals(PulseCountType.class)) {</span>
<span class="nc" id="L353">						PulseCountType el = (PulseCountType) value;</span>
<span class="nc" id="L354">						itemDescription = el.getItemDescription();</span>
<span class="nc" id="L355">						itemUnits = el.getItemUnits();</span>
<span class="nc" id="L356">						siScaleCode = SiScaleCodeType.NONE;</span>

<span class="nc bnc" id="L358" title="All 2 branches missed.">					} else if (declaredType.equals(OadrGBItemBase.class)) {</span>
<span class="nc" id="L359">						itemDescription = &quot;OadrGBItemBase&quot;;</span>
<span class="nc" id="L360">						itemUnits = &quot;OadrGBItemBase&quot;;</span>
<span class="nc" id="L361">						siScaleCode = SiScaleCodeType.NONE;</span>
					}
				}

<span class="fc" id="L365">				String marketContext = oadrReportDescriptionType.getMarketContext();</span>
<span class="fc" id="L366">				description.setRid(rid);</span>
<span class="pc bpc" id="L367" title="1 of 2 branches missed.">				if (description.getReportRequestId() == null) {</span>
<span class="fc" id="L368">					description.setReportRequestId(reportRequestID);</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">				} else if (!description.getReportRequestId().equals(reportRequestID)) {</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">					if (&quot;0&quot;.equals(description.getReportRequestId())) {</span>
<span class="nc" id="L371">						description.setReportRequestId(reportRequestID);</span>
					}
				}

				// description.setReportRequestId(reportRequestID);
<span class="fc" id="L376">				description.setReportType(ReportEnumeratedType.fromValue(reportType));</span>
<span class="fc" id="L377">				description.setReadingType(ReadingTypeEnumeratedType.fromValue(readingType));</span>
<span class="fc" id="L378">				description.setItemDescription(itemDescription);</span>
<span class="fc" id="L379">				description.setItemUnits(itemUnits);</span>
<span class="fc" id="L380">				description.setSiScaleCode(siScaleCode);</span>
<span class="fc" id="L381">				description.setOadrMaxPeriod(oadrMaxPeriod);</span>
<span class="fc" id="L382">				description.setOadrMinPeriod(oadrMinPeriod);</span>
<span class="fc" id="L383">				description.setOadrOnChange(oadrOnChange);</span>

<span class="pc bpc" id="L385" title="1 of 2 branches missed.">				if (marketContext != null) {</span>
<span class="nc" id="L386">					VenMarketContext findOneByName = venMarketContextService.findOneByName(marketContext);</span>
<span class="nc" id="L387">					description.setVenMarketContext(findOneByName);</span>
				}
<span class="fc" id="L389">				JAXBElement&lt;OadrReportDescriptionType&gt; createOadrReportDescription = Oadr20bFactory</span>
<span class="fc" id="L390">						.createOadrReportDescription(oadrReportDescriptionType);</span>
				String marshal;
				try {
<span class="fc" id="L393">					marshal = jaxbContext.marshal(createOadrReportDescription);</span>
<span class="fc" id="L394">					description.setPayload(marshal);</span>
<span class="nc" id="L395">				} catch (Oadr20bMarshalException e) {</span>
<span class="nc" id="L396">					LOGGER.warn(&quot;Can't marshall report description payload&quot;, e);</span>
<span class="fc" id="L397">				}</span>
<span class="fc" id="L398">				descriptions.add(description);</span>
<span class="fc" id="L399">				capabilityDescription.add(description);</span>

<span class="fc" id="L401">			}</span>
<span class="pc bpc" id="L402" title="1 of 2 branches missed.">			if (!created) {</span>
<span class="nc" id="L403">				this.distributeSubscriptionOadrCreatedReportPayload(ven, otherReportCapability, capabilityDescription);</span>
			}

<span class="fc" id="L406">		}</span>

<span class="fc" id="L408">		otherReportCapabilityService.save(capabilities);</span>
<span class="fc" id="L409">		otherReportCapabilityDescriptionService.save(descriptions);</span>

<span class="fc" id="L411">		Collection&lt;OtherReportCapabilityDescription&gt; toDeleteDesc = currentVenCapabilityDescriptionMap.values();</span>
<span class="fc" id="L412">		toDeleteDesc.removeAll(descriptions);</span>
<span class="pc bpc" id="L413" title="1 of 2 branches missed.">		if (!toDeleteDesc.isEmpty()) {</span>
<span class="nc" id="L414">			otherReportRequestService.deleteByOtherReportCapabilityDescriptionIn(toDeleteDesc);</span>
<span class="nc" id="L415">			otherReportCapabilityDescriptionService.delete(toDeleteDesc);</span>

		}

<span class="fc" id="L419">		Collection&lt;OtherReportCapability&gt; toDeleteCap = currentVenCapabilityMap.values();</span>
<span class="fc" id="L420">		toDeleteCap.removeAll(capabilities);</span>
<span class="pc bpc" id="L421" title="1 of 2 branches missed.">		if (!toDeleteCap.isEmpty()) {</span>
<span class="nc" id="L422">			otherReportCapabilityService.delete(toDeleteCap);</span>
		}

<span class="fc" id="L425">		OadrRegisteredReportType response = Oadr20bEiReportBuilders</span>
<span class="fc" id="L426">				.newOadr20bRegisteredReportBuilder(requestID, responseCode, venID).build();</span>

<span class="pc bpc" id="L428" title="1 of 2 branches missed.">		if (signed) {</span>
<span class="fc" id="L429">			return xmlSignatureService.sign(response);</span>
		} else {
<span class="nc" id="L431">			return jaxbContext.marshalRoot(response);</span>
		}
	}

	public void distributeRequestMetadataOadrCreateReportPayload(Ven ven) {
<span class="fc" id="L436">		String requestId = &quot;0&quot;;</span>
<span class="fc" id="L437">		String reportRequestId = &quot;0&quot;;</span>
<span class="fc" id="L438">		String reportSpecifierId = Oadr20bVTNEiReportService.METADATA_REPORT_SPECIFIER_ID;</span>
<span class="fc" id="L439">		String granularity = &quot;P0D&quot;;</span>
<span class="fc" id="L440">		String reportBackDuration = &quot;P0D&quot;;</span>
<span class="fc" id="L441">		OadrReportRequestType oadrReportRequestType = Oadr20bEiReportBuilders</span>
<span class="fc" id="L442">				.newOadr20bReportRequestTypeBuilder(reportRequestId, reportSpecifierId, granularity, reportBackDuration)</span>
<span class="fc" id="L443">				.addSpecifierPayload(null, ReadingTypeEnumeratedType.DIRECT_READ, METADATA_REPORT_RID).build();</span>
<span class="fc" id="L444">		OadrCreateReportType build = Oadr20bEiReportBuilders.newOadr20bCreateReportBuilder(requestId, ven.getUsername())</span>
<span class="fc" id="L445">				.addReportRequest(oadrReportRequestType).build();</span>

		try {
<span class="fc" id="L448">			venDistributeService.distribute(ven, build);</span>
<span class="nc" id="L449">		} catch (Oadr20bMarshalException e) {</span>
<span class="nc" id="L450">			LOGGER.error(&quot;Cannot distribute OadrRegisterReportType after self METADATA payload generation&quot;, e);</span>
<span class="fc" id="L451">		}</span>
<span class="fc" id="L452">	}</span>

	public void distributeOadrRegisterReport(Ven ven) {
<span class="fc" id="L455">		List&lt;OadrReportType&gt; reports = Lists.newArrayList();</span>
<span class="fc bfc" id="L456" title="All 2 branches covered.">		for (SelfReportCapability selfReportCapability : selfReportCapabilityService.findAll()) {</span>

<span class="fc" id="L458">			List&lt;SelfReportCapabilityDescription&gt; findBySelfReportCapability = selfReportCapabilityDescriptionService</span>
<span class="fc" id="L459">					.findBySelfReportCapability(selfReportCapability);</span>

<span class="fc" id="L461">			List&lt;OadrReportDescriptionType&gt; oadrReportDescriptionType = Lists.newArrayList();</span>
<span class="fc bfc" id="L462" title="All 2 branches covered.">			for (SelfReportCapabilityDescription description : findBySelfReportCapability) {</span>
<span class="fc" id="L463">				String descriptionPayload = description.getPayload();</span>
				try {
<span class="fc" id="L465">					OadrReportDescriptionType unmarshal = jaxbContext.unmarshal(descriptionPayload,</span>
							OadrReportDescriptionType.class);
<span class="fc" id="L467">					oadrReportDescriptionType.add(unmarshal);</span>
<span class="nc" id="L468">				} catch (Oadr20bUnmarshalException e) {</span>
<span class="nc" id="L469">					LOGGER.error(&quot;Cannot unmarshall OadrReportDescriptionType during self METADATA payload generation&quot;,</span>
							e);
<span class="fc" id="L471">				}</span>
<span class="fc" id="L472">			}</span>

<span class="fc" id="L474">			OadrReportType oadrReportType = Oadr20bEiReportBuilders</span>
<span class="fc" id="L475">					.newOadr20bRegisterReportOadrReportBuilder(selfReportCapability.getReportSpecifierId(),</span>
<span class="fc" id="L476">							selfReportCapability.getReportRequestId(), selfReportCapability.getReportName(),</span>
<span class="fc" id="L477">							System.currentTimeMillis())</span>
<span class="fc" id="L478">					.withDuration(selfReportCapability.getDuration()).addReportDescription(oadrReportDescriptionType)</span>
<span class="fc" id="L479">					.build();</span>
<span class="fc" id="L480">			reports.add(oadrReportType);</span>
<span class="fc" id="L481">		}</span>

<span class="fc" id="L483">		OadrRegisterReportType oadrRegisterReportType = Oadr20bEiReportBuilders</span>
<span class="fc" id="L484">				.newOadr20bRegisterReportBuilder(&quot;&quot;, null, &quot;&quot;).addOadrReport(reports).build();</span>

		try {
<span class="fc" id="L487">			venDistributeService.distribute(ven, oadrRegisterReportType);</span>
<span class="nc" id="L488">		} catch (Oadr20bMarshalException e) {</span>
<span class="nc" id="L489">			LOGGER.error(&quot;Cannot distribute OadrRegisterReportType after self METADATA payload generation&quot;, e);</span>
<span class="fc" id="L490">		}</span>
<span class="fc" id="L491">	}</span>

	public String oadrCreateReport(OadrCreateReportType payload, boolean signed)
			throws Oadr20bCreateReportApplicationLayerException, Oadr20bXMLSignatureException, Oadr20bMarshalException {
<span class="fc" id="L495">		String requestID = payload.getRequestID();</span>
<span class="fc" id="L496">		String venID = payload.getVenID();</span>
<span class="fc" id="L497">		Ven ven = venService.findOneByUsername(venID);</span>

<span class="pc bpc" id="L499" title="4 of 6 branches missed.">		if (ven.getXmlSignature() != null &amp;&amp; ven.getXmlSignature() &amp;&amp; !signed) {</span>
<span class="nc" id="L500">			EiResponseType xmlSignatureRequiredButAbsent = Oadr20bResponseBuilders</span>
<span class="nc" id="L501">					.newOadr20bEiResponseXmlSignatureRequiredButAbsentBuilder(requestID, venID).build();</span>
<span class="nc" id="L502">			throw new Oadr20bCreateReportApplicationLayerException(</span>
<span class="nc" id="L503">					xmlSignatureRequiredButAbsent.getResponseDescription(),</span>
<span class="nc" id="L504">					Oadr20bEiReportBuilders.newOadr20bCreatedReportBuilder(requestID,</span>
<span class="nc" id="L505">							Integer.valueOf(xmlSignatureRequiredButAbsent.getResponseCode()), venID).build());</span>
		}

<span class="fc" id="L508">		int responseCode = HttpStatus.OK_200;</span>
<span class="fc" id="L509">		List&lt;SelfReportRequest&gt; selfReportRequests = Lists.newArrayList();</span>
<span class="fc bfc" id="L510" title="All 2 branches covered.">		for (OadrReportRequestType oadrReportRequestType : payload.getOadrReportRequest()) {</span>
<span class="fc" id="L511">			String reportRequestID = oadrReportRequestType.getReportRequestID();</span>

<span class="fc" id="L513">			ReportSpecifierType reportSpecifier = oadrReportRequestType.getReportSpecifier();</span>
<span class="fc" id="L514">			DurationPropType granularity = reportSpecifier.getGranularity();</span>
<span class="fc" id="L515">			String reportSpecifierID = reportSpecifier.getReportSpecifierID();</span>
			// if reportBackDuration == 0, one shot report, else indicate the
			// frequency of report sending
<span class="fc" id="L518">			DurationPropType reportBackDuration = reportSpecifier.getReportBackDuration();</span>
<span class="fc" id="L519">			WsCalendarIntervalType reportInterval = reportSpecifier.getReportInterval();</span>
<span class="fc" id="L520">			Long start = null;</span>
<span class="fc" id="L521">			Long end = null;</span>
<span class="fc bfc" id="L522" title="All 2 branches covered.">			if (reportInterval != null) {</span>
<span class="fc" id="L523">				Properties properties = reportInterval.getProperties();</span>
<span class="fc" id="L524">				start = Oadr20bFactory.xmlCalendarToTimestamp(properties.getDtstart().getDateTime());</span>
<span class="fc" id="L525">				String duration = properties.getDuration().getDuration();</span>
<span class="fc" id="L526">				end = Oadr20bFactory.addXMLDurationToTimestamp(start, duration);</span>
			}

			// if reportSpecifierId is METADATA, no report request is actually
			// created
			// but requestor ask for oadrRegisterReport payload
<span class="fc bfc" id="L532" title="All 2 branches covered.">			if (METADATA_REPORT_SPECIFIER_ID.equals(reportSpecifierID)) {</span>

<span class="fc" id="L534">				distributeOadrRegisterReport(ven);</span>

			} else {
<span class="fc" id="L537">				SelfReportCapability selfReportCapability = selfReportCapabilityService</span>
<span class="fc" id="L538">						.findByReportSpecifierId(reportSpecifierID);</span>

<span class="fc bfc" id="L540" title="All 2 branches covered.">				for (SpecifierPayloadType specifierPayloadType : reportSpecifier.getSpecifierPayload()) {</span>
<span class="fc" id="L541">					String rid = specifierPayloadType.getRID();</span>
<span class="fc" id="L542">					String readingType = specifierPayloadType.getReadingType();</span>

<span class="fc" id="L544">					SelfReportCapabilityDescription selfReportCapabilityDescription = selfReportCapabilityDescriptionService</span>
<span class="fc" id="L545">							.findBySelfReportCapabilityAndRid(selfReportCapability, rid);</span>

<span class="fc" id="L547">					SelfReportRequest selfReportRequest = new SelfReportRequest(ven, selfReportCapability,</span>
							selfReportCapabilityDescription);
<span class="fc" id="L549">					selfReportRequest.setGranularity(granularity.getDuration());</span>
<span class="fc" id="L550">					selfReportRequest.setReportBackDuration(reportBackDuration.getDuration());</span>
<span class="fc" id="L551">					selfReportRequest.setReportRequestId(reportRequestID);</span>
<span class="fc" id="L552">					selfReportRequest.setStart(start);</span>
<span class="fc" id="L553">					selfReportRequest.setEnd(end);</span>
<span class="fc" id="L554">					selfReportRequest.setReadingType(ReadingTypeEnumeratedType.fromValue(readingType));</span>

<span class="fc" id="L556">					selfReportRequests.add(selfReportRequest);</span>
<span class="fc" id="L557">				}</span>
			}

<span class="fc" id="L560">		}</span>
<span class="fc" id="L561">		selfReportRequestService.save(selfReportRequests);</span>

<span class="fc" id="L563">		List&lt;SelfReportRequest&gt; findByTarget = selfReportRequestService.findByTarget(ven);</span>
<span class="fc" id="L564">		List&lt;String&gt; pendingReportRequestId = findByTarget.stream().map(SelfReportRequest::getReportRequestId)</span>
<span class="fc" id="L565">				.collect(Collectors.toList());</span>

<span class="fc" id="L567">		OadrCreatedReportType response = Oadr20bEiReportBuilders</span>
<span class="fc" id="L568">				.newOadr20bCreatedReportBuilder(requestID, responseCode, venID)</span>
<span class="fc" id="L569">				.addPendingReportRequestId(pendingReportRequestId).build();</span>

<span class="pc bpc" id="L571" title="1 of 2 branches missed.">		if (signed) {</span>
<span class="nc" id="L572">			return xmlSignatureService.sign(response);</span>
		} else {
<span class="fc" id="L574">			return jaxbContext.marshalRoot(response);</span>
		}
	}

	public String oadrCreatedReport(OadrCreatedReportType payload, boolean signed)
			throws Oadr20bCreatedReportApplicationLayerException, Oadr20bXMLSignatureException,
			Oadr20bMarshalException {

<span class="fc" id="L582">		EiResponseType eiResponse = payload.getEiResponse();</span>
<span class="fc" id="L583">		String requestID = eiResponse.getRequestID();</span>
<span class="fc" id="L584">		String venID = payload.getVenID();</span>

<span class="fc" id="L586">		Ven ven = venService.findOneByUsername(venID);</span>

<span class="pc bpc" id="L588" title="4 of 6 branches missed.">		if (ven.getXmlSignature() != null &amp;&amp; ven.getXmlSignature() &amp;&amp; !signed) {</span>
<span class="nc" id="L589">			EiResponseType xmlSignatureRequiredButAbsent = Oadr20bResponseBuilders</span>
<span class="nc" id="L590">					.newOadr20bEiResponseXmlSignatureRequiredButAbsentBuilder(requestID, venID).build();</span>
<span class="nc" id="L591">			throw new Oadr20bCreatedReportApplicationLayerException(</span>
<span class="nc" id="L592">					xmlSignatureRequiredButAbsent.getResponseDescription(),</span>
<span class="nc" id="L593">					Oadr20bResponseBuilders.newOadr20bResponseBuilder(xmlSignatureRequiredButAbsent, venID).build());</span>
		}

<span class="fc" id="L596">		List&lt;OtherReportRequest&gt; otherReportRequests = otherReportRequestService.findBySourceAndReportRequestIdIn(ven,</span>
<span class="fc" id="L597">				payload.getOadrPendingReports().getReportRequestID());</span>

<span class="fc" id="L599">		List&lt;OtherReportRequest&gt; collect = otherReportRequests.stream()</span>
<span class="pc bpc" id="L600" title="1 of 2 branches missed.">				.filter(otherReportRequest -&gt; !otherReportRequest.isAcked()).collect(Collectors.toList());</span>
<span class="fc bfc" id="L601" title="All 2 branches covered.">		for (OtherReportRequest report : collect) {</span>
<span class="fc" id="L602">			report.setAcked(true);</span>
<span class="fc" id="L603">		}</span>

<span class="fc" id="L605">		otherReportRequestService.save(collect);</span>

<span class="fc" id="L607">		OadrResponseType response = Oadr20bResponseBuilders</span>
<span class="fc" id="L608">				.newOadr20bResponseBuilder(requestID, HttpStatus.OK_200, venID).build();</span>

<span class="pc bpc" id="L610" title="1 of 2 branches missed.">		if (signed) {</span>
<span class="fc" id="L611">			return xmlSignatureService.sign(response);</span>
		} else {
<span class="nc" id="L613">			return jaxbContext.marshalRoot(response);</span>
		}
	}

	public String oadrCancelReport(OadrCancelReportType payload, boolean signed)
			throws Oadr20bCancelReportApplicationLayerException, Oadr20bMarshalException, Oadr20bXMLSignatureException {
<span class="fc" id="L619">		String requestID = payload.getRequestID();</span>
<span class="fc" id="L620">		String venID = payload.getVenID();</span>
<span class="fc" id="L621">		Ven ven = venService.findOneByUsername(venID);</span>
<span class="pc bpc" id="L622" title="4 of 6 branches missed.">		if (ven.getXmlSignature() != null &amp;&amp; ven.getXmlSignature() &amp;&amp; !signed) {</span>
<span class="nc" id="L623">			EiResponseType xmlSignatureRequiredButAbsent = Oadr20bResponseBuilders</span>
<span class="nc" id="L624">					.newOadr20bEiResponseXmlSignatureRequiredButAbsentBuilder(requestID, venID).build();</span>
<span class="nc" id="L625">			throw new Oadr20bCancelReportApplicationLayerException(</span>
<span class="nc" id="L626">					xmlSignatureRequiredButAbsent.getResponseDescription(),</span>
<span class="nc" id="L627">					Oadr20bEiReportBuilders.newOadr20bCanceledReportBuilder(requestID,</span>
<span class="nc" id="L628">							Integer.valueOf(xmlSignatureRequiredButAbsent.getResponseCode()), venID).build());</span>
		}

<span class="fc" id="L631">		List&lt;SelfReportRequest&gt; otherReportRequests = selfReportRequestService.findByTargetAndReportRequestId(ven,</span>
<span class="fc" id="L632">				payload.getReportRequestID());</span>

<span class="fc" id="L634">		selfReportRequestService.delete(otherReportRequests);</span>

<span class="fc" id="L636">		List&lt;SelfReportRequest&gt; pendings = selfReportRequestService.findByTarget(ven);</span>

<span class="fc" id="L638">		List&lt;String&gt; pendingReportIds = pendings.stream().map(SelfReportRequest::getReportRequestId)</span>
<span class="fc" id="L639">				.collect(Collectors.toList());</span>

<span class="fc" id="L641">		int responseCode = HttpStatus.OK_200;</span>
<span class="fc" id="L642">		OadrCanceledReportType response = Oadr20bEiReportBuilders</span>
<span class="fc" id="L643">				.newOadr20bCanceledReportBuilder(requestID, responseCode, venID)</span>
<span class="fc" id="L644">				.addPendingReportRequestId(pendingReportIds).build();</span>

<span class="pc bpc" id="L646" title="1 of 2 branches missed.">		if (signed) {</span>
<span class="fc" id="L647">			return xmlSignatureService.sign(response);</span>
		} else {
<span class="nc" id="L649">			return jaxbContext.marshalRoot(response);</span>
		}
	}

	public void otherOadrCancelReport(OadrCancelReportType payload)
			throws Oadr20bCancelReportApplicationLayerException {
<span class="nc" id="L655">		String venID = payload.getVenID();</span>
<span class="nc" id="L656">		Ven ven = venService.findOneByUsername(venID);</span>

<span class="nc" id="L658">		List&lt;OtherReportRequest&gt; otherReportRequests = otherReportRequestService.findBySourceAndReportRequestIdIn(ven,</span>
<span class="nc" id="L659">				payload.getReportRequestID());</span>

<span class="nc bnc" id="L661" title="All 4 branches missed.">		if (otherReportRequests != null &amp;&amp; !otherReportRequests.isEmpty()) {</span>
<span class="nc" id="L662">			otherReportRequestService.delete(otherReportRequests);</span>
		}

<span class="nc" id="L665">	}</span>

	public String oadrUpdateReport(OadrUpdateReportType payload, boolean signed)
			throws Oadr20bUpdateReportApplicationLayerException, Oadr20bXMLSignatureException, Oadr20bMarshalException {

<span class="fc" id="L670">		String requestID = payload.getRequestID();</span>
<span class="fc" id="L671">		String venID = payload.getVenID();</span>
<span class="fc" id="L672">		Ven ven = venService.findOneByUsername(venID);</span>

<span class="fc" id="L674">		Long now = System.currentTimeMillis();</span>

<span class="pc bpc" id="L676" title="4 of 6 branches missed.">		if (ven.getXmlSignature() != null &amp;&amp; ven.getXmlSignature() &amp;&amp; !signed) {</span>
<span class="nc" id="L677">			EiResponseType xmlSignatureRequiredButAbsent = Oadr20bResponseBuilders</span>
<span class="nc" id="L678">					.newOadr20bEiResponseXmlSignatureRequiredButAbsentBuilder(requestID, venID).build();</span>
<span class="nc" id="L679">			throw new Oadr20bUpdateReportApplicationLayerException(</span>
<span class="nc" id="L680">					xmlSignatureRequiredButAbsent.getResponseDescription(),</span>
<span class="nc" id="L681">					Oadr20bEiReportBuilders.newOadr20bUpdatedReportBuilder(requestID,</span>
<span class="nc" id="L682">							Integer.valueOf(xmlSignatureRequiredButAbsent.getResponseCode()), venID).build());</span>
		}

<span class="fc" id="L685">		int responseCode = HttpStatus.OK_200;</span>

<span class="fc" id="L687">		List&lt;OtherReportData&gt; list = Lists.newArrayList();</span>
<span class="fc bfc" id="L688" title="All 2 branches covered.">		for (OadrReportType oadrReportType : payload.getOadrReport()) {</span>
<span class="fc" id="L689">			String reportRequestID = oadrReportType.getReportRequestID();</span>
<span class="fc" id="L690">			String reportSpecifierID = oadrReportType.getReportSpecifierID();</span>
<span class="fc" id="L691">			Intervals intervals = oadrReportType.getIntervals();</span>

<span class="fc" id="L693">			List&lt;OtherReportRequest&gt; findByReportRequestId = otherReportRequestService</span>
<span class="fc" id="L694">					.findByReportRequestId(reportRequestID);</span>

<span class="fc" id="L696">			Map&lt;String, OtherReportRequest&gt; requests = Maps.newHashMap();</span>
<span class="fc bfc" id="L697" title="All 2 branches covered.">			for (OtherReportRequest r : findByReportRequestId) {</span>
<span class="fc" id="L698">				requests.put(r.getOtherReportCapabilityDescription().getRid(), r);</span>
<span class="fc" id="L699">			}</span>

<span class="fc" id="L701">			List&lt;OtherReportRequest&gt; toUpdate = Lists.newArrayList();</span>
<span class="fc bfc" id="L702" title="All 2 branches covered.">			for (IntervalType intervalType : intervals.getInterval()) {</span>

<span class="fc" id="L704">				Dtstart intervalDtstart = intervalType.getDtstart();</span>
<span class="fc" id="L705">				Long start = Oadr20bFactory.xmlCalendarToTimestamp(intervalDtstart.getDateTime());</span>
<span class="fc" id="L706">				DurationPropType intervalDuration = intervalType.getDuration();</span>
<span class="fc" id="L707">				String durationInterval = intervalDuration.getDuration();</span>
<span class="fc bfc" id="L708" title="All 2 branches covered.">				for (JAXBElement&lt;? extends StreamPayloadBaseType&gt; jaxbElement : intervalType.getStreamPayloadBase()) {</span>
<span class="pc bpc" id="L709" title="1 of 2 branches missed.">					if (jaxbElement.getDeclaredType().equals(OadrReportPayloadType.class)) {</span>

<span class="fc" id="L711">						OadrReportPayloadType reportPayload = (OadrReportPayloadType) jaxbElement.getValue();</span>
<span class="fc" id="L712">						String rid = reportPayload.getRID();</span>

<span class="fc" id="L714">						Long confidence = reportPayload.getConfidence();</span>
<span class="fc" id="L715">						Float accuracy = reportPayload.getAccuracy();</span>

<span class="fc" id="L717">						String lastUpdateValue = null;</span>

<span class="fc" id="L719">						OtherReportData otherReportData = new OtherReportData();</span>
<span class="fc" id="L720">						otherReportData.setStart(start);</span>
<span class="fc" id="L721">						otherReportData.setDuration(durationInterval);</span>
<span class="fc" id="L722">						otherReportData.setReportSpecifierId(reportSpecifierID);</span>
<span class="fc" id="L723">						otherReportData.setRid(rid);</span>
<span class="fc" id="L724">						otherReportData.setConfidence(confidence);</span>
<span class="fc" id="L725">						otherReportData.setAccuracy(accuracy);</span>

<span class="fc" id="L727">						JAXBElement&lt;? extends PayloadBaseType&gt; payloadBase = reportPayload.getPayloadBase();</span>
<span class="fc bfc" id="L728" title="All 2 branches covered.">						if (payloadBase.getDeclaredType().equals(PayloadFloatType.class)) {</span>

<span class="fc" id="L730">							PayloadFloatType payloadFloat = (PayloadFloatType) payloadBase.getValue();</span>
<span class="fc" id="L731">							float value = payloadFloat.getValue();</span>
<span class="fc" id="L732">							otherReportData.setValue(value);</span>
<span class="fc" id="L733">							lastUpdateValue = String.valueOf(value);</span>
<span class="fc" id="L734">							list.add(otherReportData);</span>

<span class="pc bpc" id="L736" title="1 of 2 branches missed.">							if (requests.containsKey(rid)) {</span>
<span class="fc" id="L737">								OtherReportRequest otherReportRequest = requests.get(rid);</span>
<span class="pc bpc" id="L738" title="1 of 2 branches missed.">								if (otherReportRequest.getLastUpdateDatetime() == null</span>
<span class="nc bnc" id="L739" title="All 2 branches missed.">										|| otherReportRequest.getLastUpdateDatetime() &lt; start) {</span>
<span class="fc" id="L740">									otherReportRequest.setLastUpdateDatetime(start);</span>
<span class="fc" id="L741">									otherReportRequest.setLastUpdateValue(lastUpdateValue);</span>
								}

<span class="fc" id="L744">								toUpdate.add(otherReportRequest);</span>
							}

<span class="pc bpc" id="L747" title="1 of 2 branches missed.">						} else if (payloadBase.getDeclaredType().equals(OadrPayloadResourceStatusType.class)) {</span>
<span class="fc" id="L748">							OadrPayloadResourceStatusType payloadResourceStatus = (OadrPayloadResourceStatusType) payloadBase</span>
<span class="fc" id="L749">									.getValue();</span>

<span class="fc" id="L751">							OadrLoadControlStateTypeType oadrCapacity = payloadResourceStatus.getOadrLoadControlState()</span>
<span class="fc" id="L752">									.getOadrCapacity();</span>
<span class="pc bpc" id="L753" title="1 of 2 branches missed.">							if (oadrCapacity != null) {</span>
<span class="fc" id="L754">								otherReportData.setOadrCapacityCurrent(oadrCapacity.getOadrCurrent());</span>
<span class="fc" id="L755">								otherReportData.setOadrCapacityMin(oadrCapacity.getOadrMin());</span>
<span class="fc" id="L756">								otherReportData.setOadrCapacityMax(oadrCapacity.getOadrMax());</span>
<span class="fc" id="L757">								otherReportData.setOadrCapacityNormal(oadrCapacity.getOadrNormal());</span>
							}

<span class="fc" id="L760">							OadrLoadControlStateTypeType oadrLevelOffset = payloadResourceStatus</span>
<span class="fc" id="L761">									.getOadrLoadControlState().getOadrLevelOffset();</span>
<span class="pc bpc" id="L762" title="1 of 2 branches missed.">							if (oadrLevelOffset != null) {</span>
<span class="nc" id="L763">								otherReportData.setOadrLevelOffsetCurrent(oadrLevelOffset.getOadrCurrent());</span>
<span class="nc" id="L764">								otherReportData.setOadrLevelOffsetMin(oadrLevelOffset.getOadrMin());</span>
<span class="nc" id="L765">								otherReportData.setOadrLevelOffsetMax(oadrLevelOffset.getOadrMax());</span>
<span class="nc" id="L766">								otherReportData.setOadrLevelOffsetNormal(oadrLevelOffset.getOadrNormal());</span>
							}

<span class="fc" id="L769">							OadrLoadControlStateTypeType oadrPercentOffset = payloadResourceStatus</span>
<span class="fc" id="L770">									.getOadrLoadControlState().getOadrPercentOffset();</span>
<span class="pc bpc" id="L771" title="1 of 2 branches missed.">							if (oadrPercentOffset != null) {</span>
<span class="nc" id="L772">								otherReportData.setOadrPercentOffsetCurrent(oadrPercentOffset.getOadrCurrent());</span>
<span class="nc" id="L773">								otherReportData.setOadrPercentOffsetMin(oadrPercentOffset.getOadrMin());</span>
<span class="nc" id="L774">								otherReportData.setOadrPercentOffsetMax(oadrPercentOffset.getOadrMax());</span>
<span class="nc" id="L775">								otherReportData.setOadrPercentOffsetNormal(oadrPercentOffset.getOadrNormal());</span>
							}

<span class="fc" id="L778">							OadrLoadControlStateTypeType oadrSetPoint = payloadResourceStatus.getOadrLoadControlState()</span>
<span class="fc" id="L779">									.getOadrSetPoint();</span>
<span class="pc bpc" id="L780" title="1 of 2 branches missed.">							if (oadrSetPoint != null) {</span>
<span class="nc" id="L781">								otherReportData.setOadrSetPointCurrent(oadrSetPoint.getOadrCurrent());</span>
<span class="nc" id="L782">								otherReportData.setOadrSetPointMin(oadrSetPoint.getOadrMin());</span>
<span class="nc" id="L783">								otherReportData.setOadrSetPointMax(oadrSetPoint.getOadrMax());</span>
<span class="nc" id="L784">								otherReportData.setOadrSetPointNormal(oadrSetPoint.getOadrNormal());</span>
							}

<span class="fc" id="L787">							list.add(otherReportData);</span>
						}

					}
<span class="fc" id="L791">				}</span>
<span class="fc" id="L792">			}</span>

<span class="pc bpc" id="L794" title="1 of 2 branches missed.">			if (saveVenData) {</span>
<span class="fc" id="L795">				otherReportDataService.save(list);</span>
			}

<span class="fc" id="L798">			otherReportRequestService.save(toUpdate);</span>
<span class="fc" id="L799">		}</span>

<span class="fc" id="L801">		ven.setLastUpdateDatetime(now);</span>

<span class="fc" id="L803">		venService.save(ven);</span>

<span class="fc" id="L805">		OadrUpdatedReportType response = Oadr20bEiReportBuilders</span>
<span class="fc" id="L806">				.newOadr20bUpdatedReportBuilder(requestID, responseCode, venID).build();</span>

<span class="pc bpc" id="L808" title="1 of 2 branches missed.">		if (signed) {</span>
<span class="nc" id="L809">			return xmlSignatureService.sign(response);</span>
		} else {
<span class="fc" id="L811">			return jaxbContext.marshalRoot(response);</span>
		}
	}

	public void distributeSubscriptionOadrCreatedReportPayload(Ven ven, OtherReportCapability reportCapability,
			List&lt;OtherReportCapabilityDescription&gt; descriptions) throws Oadr20bMarshalException {

<span class="nc" id="L818">		boolean send = false;</span>
<span class="nc" id="L819">		String requestId = &quot;&quot;;</span>
<span class="nc" id="L820">		Oadr20bCreateReportBuilder newOadr20bCreateReportBuilder = Oadr20bEiReportBuilders</span>
<span class="nc" id="L821">				.newOadr20bCreateReportBuilder(requestId, ven.getUsername());</span>

<span class="nc bnc" id="L823" title="All 2 branches missed.">		for (OtherReportCapabilityDescription description : descriptions) {</span>

<span class="nc bnc" id="L825" title="All 2 branches missed.">			if (description.getId() != null) {</span>
<span class="nc" id="L826">				OtherReportRequest otherReportRequest = otherReportRequestService</span>
<span class="nc" id="L827">						.findBySourceAndOtherReportCapabilityDescriptionAndReportRequestId(ven, description,</span>
<span class="nc" id="L828">								reportCapability.getReportRequestId());</span>
<span class="nc bnc" id="L829" title="All 2 branches missed.">				if (otherReportRequest != null) {</span>

<span class="nc" id="L831">					String granularity = otherReportRequest.getGranularity();</span>
<span class="nc" id="L832">					String reportBackDuration = otherReportRequest.getReportBackDuration();</span>
<span class="nc" id="L833">					String reportRequestId = otherReportRequest.getReportRequestId();</span>

<span class="nc" id="L835">					send = true;</span>
<span class="nc" id="L836">					Oadr20bReportRequestTypeBuilder reportRequestBuilder = Oadr20bEiReportBuilders</span>
<span class="nc" id="L837">							.newOadr20bReportRequestTypeBuilder(reportRequestId,</span>
<span class="nc" id="L838">									reportCapability.getReportSpecifierId(), granularity, reportBackDuration);</span>

<span class="nc bnc" id="L840" title="All 4 branches missed.">					if (otherReportRequest.getStart() != null &amp;&amp; otherReportRequest.getEnd() != null) {</span>
<span class="nc" id="L841">						String duration = Oadr20bFactory</span>
<span class="nc" id="L842">								.millisecondToXmlDuration(otherReportRequest.getEnd() - otherReportRequest.getStart());</span>
<span class="nc" id="L843">						WsCalendarIntervalType createWsCalendarIntervalType = Oadr20bFactory</span>
<span class="nc" id="L844">								.createWsCalendarIntervalType(otherReportRequest.getStart(), duration);</span>
<span class="nc" id="L845">						reportRequestBuilder.withWsCalendarIntervalType(createWsCalendarIntervalType);</span>
					}

<span class="nc" id="L848">					reportRequestBuilder.addSpecifierPayload(null, description.getReadingType(), description.getRid());</span>

<span class="nc" id="L850">					newOadr20bCreateReportBuilder.addReportRequest(reportRequestBuilder.build());</span>
				}
			}

<span class="nc" id="L854">		}</span>
<span class="nc bnc" id="L855" title="All 2 branches missed.">		if (send) {</span>
<span class="nc" id="L856">			venDistributeService.distribute(ven, newOadr20bCreateReportBuilder.build());</span>
		}
<span class="nc" id="L858">	}</span>

	public void distributeSubscriptionOadrCreatedReportPayload(Ven ven, List&lt;OtherReportRequest&gt; requests)
			throws Oadr20bMarshalException {

<span class="nc" id="L863">		boolean send = false;</span>
<span class="nc" id="L864">		String requestId = &quot;&quot;;</span>
<span class="nc" id="L865">		Oadr20bCreateReportBuilder newOadr20bCreateReportBuilder = Oadr20bEiReportBuilders</span>
<span class="nc" id="L866">				.newOadr20bCreateReportBuilder(requestId, ven.getUsername());</span>

<span class="nc bnc" id="L868" title="All 2 branches missed.">		for (OtherReportRequest request : requests) {</span>

<span class="nc" id="L870">			OtherReportCapability otherReportCapability = request.getOtherReportCapability();</span>
<span class="nc" id="L871">			OtherReportCapabilityDescription otherReportCapabilityDescription = request</span>
<span class="nc" id="L872">					.getOtherReportCapabilityDescription();</span>

<span class="nc" id="L874">			String granularity = request.getGranularity();</span>
<span class="nc" id="L875">			String reportBackDuration = request.getReportBackDuration();</span>
<span class="nc" id="L876">			String reportRequestId = request.getReportRequestId();</span>

<span class="nc" id="L878">			send = true;</span>
<span class="nc" id="L879">			Oadr20bReportRequestTypeBuilder reportRequestBuilder = Oadr20bEiReportBuilders</span>
<span class="nc" id="L880">					.newOadr20bReportRequestTypeBuilder(reportRequestId, otherReportCapability.getReportSpecifierId(),</span>
							granularity, reportBackDuration);

<span class="nc bnc" id="L883" title="All 4 branches missed.">			if (request.getStart() != null &amp;&amp; request.getEnd() != null) {</span>
<span class="nc" id="L884">				String duration = Oadr20bFactory.millisecondToXmlDuration(request.getEnd() - request.getStart());</span>
<span class="nc" id="L885">				WsCalendarIntervalType createWsCalendarIntervalType = Oadr20bFactory</span>
<span class="nc" id="L886">						.createWsCalendarIntervalType(request.getStart(), duration);</span>
<span class="nc" id="L887">				reportRequestBuilder.withWsCalendarIntervalType(createWsCalendarIntervalType);</span>
<span class="nc bnc" id="L888" title="All 2 branches missed.">			} else if (request.getStart() != null) {</span>
<span class="nc" id="L889">				String duration = &quot;P0D&quot;;</span>
<span class="nc" id="L890">				WsCalendarIntervalType createWsCalendarIntervalType = Oadr20bFactory</span>
<span class="nc" id="L891">						.createWsCalendarIntervalType(request.getStart(), duration);</span>
<span class="nc" id="L892">				reportRequestBuilder.withWsCalendarIntervalType(createWsCalendarIntervalType);</span>
			}

<span class="nc" id="L895">			reportRequestBuilder.addSpecifierPayload(null, otherReportCapabilityDescription.getReadingType(),</span>
<span class="nc" id="L896">					otherReportCapabilityDescription.getRid());</span>

<span class="nc" id="L898">			newOadr20bCreateReportBuilder.addReportRequest(reportRequestBuilder.build());</span>

<span class="nc" id="L900">		}</span>
<span class="nc bnc" id="L901" title="All 2 branches missed.">		if (send) {</span>
<span class="nc" id="L902">			venDistributeService.distribute(ven, newOadr20bCreateReportBuilder.build());</span>
		}
<span class="nc" id="L904">	}</span>

	/**
	 * @param ven
	 * @param reportCapability
	 * @param rids
	 * @param reportBackDuration
	 * @param granularity
	 * @throws Oadr20bMarshalException
	 */
	public void subscribe(Ven ven, OtherReportCapability reportCapability, List&lt;String&gt; rids, String reportBackDuration,
			String granularity, Long start, Long end) throws Oadr20bMarshalException {

<span class="nc" id="L917">		String reportRequestId = null;</span>

<span class="nc bnc" id="L919" title="All 4 branches missed.">		if (reportCapability.getReportRequestId() == null || &quot;0&quot;.equals(reportCapability.getReportRequestId())) {</span>
<span class="nc" id="L920">			reportRequestId = UUID.randomUUID().toString();</span>
<span class="nc bnc" id="L921" title="All 4 branches missed.">			if (reportBackDuration == null || granularity == null) {</span>
<span class="nc" id="L922">				throw new IllegalArgumentException(</span>
						&quot;Must provide reportBackDuration and granularity because report as not already been subscribed&quot;);
			}
		} else {
<span class="nc" id="L926">			reportRequestId = reportCapability.getReportRequestId();</span>
		}

<span class="nc" id="L929">		List&lt;OtherReportCapabilityDescription&gt; descriptions = otherReportCapabilityDescriptionService</span>
<span class="nc" id="L930">				.findByOtherReportCapability(reportCapability);</span>

<span class="nc bnc" id="L932" title="All 4 branches missed.">		if (descriptions == null || descriptions.isEmpty()) {</span>
<span class="nc" id="L933">			throw new IllegalArgumentException(&quot;reportCapability is not associated with any description&quot;);</span>
		}

<span class="nc" id="L936">		Long granularityMillisecond = null;</span>
<span class="nc" id="L937">		Long reportBackDurationMillisecond = null;</span>
<span class="nc bnc" id="L938" title="All 6 branches missed.">		if (granularity == null &amp;&amp; reportBackDuration == null &amp;&amp; reportCapability.getReportRequestBackDuration() != null</span>
<span class="nc bnc" id="L939" title="All 2 branches missed.">				&amp;&amp; reportCapability.getReportRequestGranularity() != null) {</span>
<span class="nc" id="L940">			granularity = reportCapability.getReportRequestGranularity();</span>
<span class="nc" id="L941">			reportBackDuration = reportCapability.getReportRequestBackDuration();</span>

		}

<span class="nc" id="L945">		granularityMillisecond = Oadr20bFactory.xmlDurationToMillisecond(granularity);</span>
<span class="nc" id="L946">		reportBackDurationMillisecond = Oadr20bFactory.xmlDurationToMillisecond(reportBackDuration);</span>

<span class="nc bnc" id="L948" title="All 4 branches missed.">		if (granularityMillisecond == null || reportBackDurationMillisecond == null) {</span>
<span class="nc" id="L949">			throw new IllegalArgumentException(</span>
					&quot;reportBackDuration and granularity must be valid xmlduration lexical representation (PnYnMnDTnHnMnS)&quot;);
		}

<span class="nc" id="L953">		List&lt;OtherReportRequest&gt; otherReportRequests = new ArrayList&lt;OtherReportRequest&gt;();</span>
<span class="nc bnc" id="L954" title="All 2 branches missed.">		for (OtherReportCapabilityDescription description : descriptions) {</span>

<span class="nc bnc" id="L956" title="All 4 branches missed.">			if (rids == null || rids.contains(description.getRid())) {</span>

<span class="nc" id="L958">				OtherReportRequest otherReportRequest = otherReportRequestService</span>
<span class="nc" id="L959">						.findBySourceAndOtherReportCapabilityDescriptionAndReportRequestId(ven, description,</span>
								reportRequestId);

<span class="nc bnc" id="L962" title="All 2 branches missed.">				if (otherReportRequest == null) {</span>
<span class="nc" id="L963">					otherReportRequest = new OtherReportRequest(ven, reportCapability, description, reportRequestId,</span>
							granularity, reportBackDuration);
				}

<span class="nc" id="L967">				otherReportRequest.setGranularity(granularity);</span>
<span class="nc" id="L968">				otherReportRequest.setReportBackDuration(reportBackDuration);</span>
<span class="nc" id="L969">				otherReportRequest.setStart(start);</span>
<span class="nc" id="L970">				otherReportRequest.setEnd(end);</span>

<span class="nc" id="L972">				otherReportRequests.add(otherReportRequest);</span>

<span class="nc bnc" id="L974" title="All 2 branches missed.">				if (reportCapability.getReportName().equals(ReportNameEnumeratedType.METADATA_TELEMETRY_USAGE)</span>
<span class="nc bnc" id="L975" title="All 2 branches missed.">						|| reportCapability.getReportName().equals(ReportNameEnumeratedType.METADATA_TELEMETRY_STATUS)</span>
<span class="nc bnc" id="L976" title="All 2 branches missed.">						|| reportCapability.getReportName().equals(ReportNameEnumeratedType.METADATA_HISTORY_USAGE)) {</span>

<span class="nc" id="L978">					description.setReportRequestBackDuration(reportBackDuration);</span>
<span class="nc" id="L979">					description.setReportRequestGranularity(granularity);</span>

				}

			}

<span class="nc bnc" id="L985" title="All 2 branches missed.">			if (reportCapability.getReportName().equals(ReportNameEnumeratedType.METADATA_TELEMETRY_USAGE)</span>
<span class="nc bnc" id="L986" title="All 2 branches missed.">					|| reportCapability.getReportName().equals(ReportNameEnumeratedType.METADATA_TELEMETRY_STATUS)</span>
<span class="nc bnc" id="L987" title="All 2 branches missed.">					|| reportCapability.getReportName().equals(ReportNameEnumeratedType.METADATA_HISTORY_USAGE)) {</span>

<span class="nc" id="L989">				description.setReportRequestId(reportRequestId);</span>
			}

<span class="nc" id="L992">		}</span>

<span class="nc bnc" id="L994" title="All 2 branches missed.">		if (reportCapability.getReportName().equals(ReportNameEnumeratedType.METADATA_TELEMETRY_USAGE)</span>
<span class="nc bnc" id="L995" title="All 2 branches missed.">				|| reportCapability.getReportName().equals(ReportNameEnumeratedType.METADATA_TELEMETRY_STATUS)</span>
<span class="nc bnc" id="L996" title="All 2 branches missed.">				|| reportCapability.getReportName().equals(ReportNameEnumeratedType.METADATA_HISTORY_USAGE)) {</span>

<span class="nc" id="L998">			reportCapability.setReportRequestId(reportRequestId);</span>
<span class="nc" id="L999">			reportCapability.setReportRequestBackDuration(reportBackDuration);</span>
<span class="nc" id="L1000">			reportCapability.setReportRequestGranularity(granularity);</span>

<span class="nc" id="L1002">			otherReportCapabilityService.save(reportCapability);</span>

<span class="nc" id="L1004">			otherReportCapabilityDescriptionService.save(descriptions);</span>
		}

<span class="nc" id="L1007">		otherReportRequestService.save(otherReportRequests);</span>

<span class="nc" id="L1009">		distributeSubscriptionOadrCreatedReportPayload(ven, reportCapability, descriptions);</span>

<span class="nc" id="L1011">	}</span>

	public void request(Ven ven, OtherReportCapability reportCapability, List&lt;String&gt; rids, Long start, Long end)
			throws Oadr20bMarshalException {

<span class="nc" id="L1016">		String reportRequestId = UUID.randomUUID().toString();</span>

<span class="nc" id="L1018">		List&lt;OtherReportCapabilityDescription&gt; descriptions = otherReportCapabilityDescriptionService</span>
<span class="nc" id="L1019">				.findByOtherReportCapability(reportCapability);</span>

<span class="nc bnc" id="L1021" title="All 4 branches missed.">		if (descriptions == null || descriptions.isEmpty()) {</span>
<span class="nc" id="L1022">			throw new IllegalArgumentException(&quot;reportCapability is not associated with any description&quot;);</span>
		}

<span class="nc" id="L1025">		List&lt;OtherReportRequest&gt; otherReportRequests = new ArrayList&lt;OtherReportRequest&gt;();</span>
<span class="nc bnc" id="L1026" title="All 2 branches missed.">		for (OtherReportCapabilityDescription description : descriptions) {</span>

<span class="nc bnc" id="L1028" title="All 4 branches missed.">			if (rids == null || rids.contains(description.getRid())) {</span>

<span class="nc" id="L1030">				OtherReportRequest otherReportRequest = new OtherReportRequest(ven, reportCapability, description,</span>
						reportRequestId, &quot;P0D&quot;, &quot;P0D&quot;);

<span class="nc" id="L1033">				otherReportRequest.setGranularity(&quot;P0D&quot;);</span>
<span class="nc" id="L1034">				otherReportRequest.setReportBackDuration(&quot;P0D&quot;);</span>
<span class="nc" id="L1035">				otherReportRequest.setStart(start);</span>
<span class="nc" id="L1036">				otherReportRequest.setEnd(end);</span>
<span class="nc" id="L1037">				otherReportRequest.setReportRequestId(reportRequestId);</span>
<span class="nc" id="L1038">				otherReportRequests.add(otherReportRequest);</span>

			}

<span class="nc" id="L1042">		}</span>

<span class="nc" id="L1044">		otherReportRequestService.save(otherReportRequests);</span>

<span class="nc" id="L1046">		List&lt;OtherReportRequest&gt; findBySourceAndReportSpecifierId = otherReportRequestService</span>
<span class="nc" id="L1047">				.findBySourceAndReportSpecifierId(ven, reportCapability.getReportSpecifierId());</span>
<span class="nc" id="L1048">		otherReportRequests.addAll(findBySourceAndReportSpecifierId);</span>
<span class="nc" id="L1049">		distributeSubscriptionOadrCreatedReportPayload(ven, otherReportRequests);</span>

<span class="nc" id="L1051">	}</span>

	public void removeFromSubscription(Ven ven, OtherReportCapability reportCapability, List&lt;String&gt; rids)
			throws Oadr20bMarshalException, OadrElementNotFoundException {

<span class="nc" id="L1056">		String reportRequestId = reportCapability.getReportRequestId();</span>

<span class="nc" id="L1058">		List&lt;OtherReportCapabilityDescription&gt; descriptions = otherReportCapabilityDescriptionService</span>
<span class="nc" id="L1059">				.findByOtherReportCapability(reportCapability);</span>

<span class="nc" id="L1061">		List&lt;OtherReportRequest&gt; otherReportRequests = new ArrayList&lt;OtherReportRequest&gt;();</span>
<span class="nc" id="L1062">		boolean stillSubscribed = false;</span>
<span class="nc bnc" id="L1063" title="All 2 branches missed.">		for (OtherReportCapabilityDescription description : descriptions) {</span>

<span class="nc bnc" id="L1065" title="All 2 branches missed.">			if (rids.contains(description.getRid())) {</span>

<span class="nc" id="L1067">				OtherReportRequest otherReportRequest = otherReportRequestService</span>
<span class="nc" id="L1068">						.findBySourceAndOtherReportCapabilityDescriptionAndReportRequestId(ven, description,</span>
								reportRequestId);

<span class="nc bnc" id="L1071" title="All 2 branches missed.">				if (otherReportRequest != null) {</span>
<span class="nc" id="L1072">					otherReportRequests.add(otherReportRequest);</span>
				}

<span class="nc" id="L1075">				description.setReportRequestBackDuration(null);</span>
<span class="nc" id="L1076">				description.setReportRequestGranularity(null);</span>

<span class="nc bnc" id="L1078" title="All 2 branches missed.">			} else if (description.getReportRequestGranularity() != null</span>
<span class="nc bnc" id="L1079" title="All 2 branches missed.">					&amp;&amp; description.getReportRequestBackDuration() != null) {</span>
<span class="nc" id="L1080">				stillSubscribed = true;</span>
			}

<span class="nc" id="L1083">			description.setReportRequestId(reportRequestId);</span>

<span class="nc" id="L1085">		}</span>

<span class="nc bnc" id="L1087" title="All 2 branches missed.">		if (stillSubscribed) {</span>
<span class="nc" id="L1088">			otherReportRequestService.delete(otherReportRequests);</span>

<span class="nc" id="L1090">			otherReportCapabilityDescriptionService.save(descriptions);</span>

<span class="nc" id="L1092">			distributeSubscriptionOadrCreatedReportPayload(ven, reportCapability, descriptions);</span>
		} else {
<span class="nc" id="L1094">			this.unsubscribe(ven, reportRequestId);</span>
		}

<span class="nc" id="L1097">	}</span>

	public void unsubscribe(Ven ven, String reportRequestID)
			throws OadrElementNotFoundException, Oadr20bMarshalException {

<span class="nc" id="L1102">		Iterable&lt;OtherReportCapability&gt; findByPayloadReportRequestId2 = otherReportCapabilityService</span>
<span class="nc" id="L1103">				.findByReportRequestId(Arrays.asList(reportRequestID));</span>
<span class="nc bnc" id="L1104" title="All 2 branches missed.">		for (OtherReportCapability cap : findByPayloadReportRequestId2) {</span>
<span class="nc" id="L1105">			cap.setReportRequestId(&quot;0&quot;);</span>
<span class="nc" id="L1106">			cap.setReportRequestBackDuration(null);</span>
<span class="nc" id="L1107">			cap.setReportRequestGranularity(null);</span>
<span class="nc" id="L1108">		}</span>

<span class="nc" id="L1110">		otherReportCapabilityService.save(findByPayloadReportRequestId2);</span>

<span class="nc" id="L1112">		Iterable&lt;OtherReportCapabilityDescription&gt; findByPayloadReportRequestId = otherReportCapabilityDescriptionService</span>
<span class="nc" id="L1113">				.findByReportRequestId(Arrays.asList(reportRequestID));</span>
<span class="nc bnc" id="L1114" title="All 2 branches missed.">		for (OtherReportCapabilityDescription description : findByPayloadReportRequestId) {</span>
<span class="nc" id="L1115">			description.setReportRequestId(&quot;0&quot;);</span>
<span class="nc" id="L1116">			description.setReportRequestBackDuration(null);</span>
<span class="nc" id="L1117">			description.setReportRequestGranularity(null);</span>
<span class="nc" id="L1118">		}</span>

<span class="nc" id="L1120">		otherReportCapabilityDescriptionService.save(findByPayloadReportRequestId);</span>

<span class="nc" id="L1122">		List&lt;OtherReportRequest&gt; findByReportRequestId = otherReportRequestService</span>
<span class="nc" id="L1123">				.findByReportRequestId(reportRequestID);</span>
<span class="nc" id="L1124">		otherReportRequestService.delete(findByReportRequestId);</span>

<span class="nc" id="L1126">		String requestId = &quot;&quot;;</span>
<span class="nc" id="L1127">		OadrCancelReportType build = Oadr20bEiReportBuilders</span>
<span class="nc" id="L1128">				.newOadr20bCancelReportBuilder(requestId, ven.getUsername(), false).addReportRequestId(reportRequestID)</span>
<span class="nc" id="L1129">				.build();</span>

<span class="nc" id="L1131">		venDistributeService.distribute(ven, build);</span>
<span class="nc" id="L1132">	}</span>

	public void checkMatchUsernameWithRequestVenId(String username, OadrRegisterReportType oadrRegisterReport)
			throws Oadr20bRegisterReportApplicationLayerException {
<span class="fc" id="L1136">		String venID = oadrRegisterReport.getVenID();</span>
<span class="fc" id="L1137">		String requestID = oadrRegisterReport.getRequestID();</span>
<span class="fc bfc" id="L1138" title="All 2 branches covered.">		if (!username.equals(venID)) {</span>
<span class="fc" id="L1139">			EiResponseType mismatchCredentialsVenIdResponse = Oadr20bResponseBuilders</span>
<span class="fc" id="L1140">					.newOadr20bEiResponseMismatchUsernameVenIdBuilder(requestID, username, venID).build();</span>
<span class="fc" id="L1141">			throw new Oadr20bRegisterReportApplicationLayerException(</span>
<span class="fc" id="L1142">					mismatchCredentialsVenIdResponse.getResponseDescription(),</span>
					Oadr20bEiReportBuilders
<span class="fc" id="L1144">							.newOadr20bRegisteredReportBuilder(requestID,</span>
<span class="fc" id="L1145">									Integer.valueOf(mismatchCredentialsVenIdResponse.getResponseCode()), venID)</span>
<span class="fc" id="L1146">							.build());</span>
		}
<span class="fc" id="L1148">	}</span>

	public void checkMatchUsernameWithRequestVenId(String username, OadrUpdateReportType oadrUpdateReport)
			throws Oadr20bUpdateReportApplicationLayerException {
<span class="fc" id="L1152">		String venID = oadrUpdateReport.getVenID();</span>
<span class="fc" id="L1153">		String requestID = oadrUpdateReport.getRequestID();</span>
<span class="fc bfc" id="L1154" title="All 2 branches covered.">		if (!username.equals(venID)) {</span>
<span class="fc" id="L1155">			EiResponseType mismatchCredentialsVenIdResponse = Oadr20bResponseBuilders</span>
<span class="fc" id="L1156">					.newOadr20bEiResponseMismatchUsernameVenIdBuilder(requestID, username, venID).build();</span>
<span class="fc" id="L1157">			throw new Oadr20bUpdateReportApplicationLayerException(</span>
<span class="fc" id="L1158">					mismatchCredentialsVenIdResponse.getResponseDescription(),</span>
					Oadr20bEiReportBuilders
<span class="fc" id="L1160">							.newOadr20bUpdatedReportBuilder(requestID,</span>
<span class="fc" id="L1161">									Integer.valueOf(mismatchCredentialsVenIdResponse.getResponseCode()), venID)</span>
<span class="fc" id="L1162">							.build());</span>
		}
<span class="fc" id="L1164">	}</span>

	public void checkMatchUsernameWithRequestVenId(String username, OadrCreatedReportType oadrCreatedReport)
			throws Oadr20bCreatedReportApplicationLayerException {
<span class="fc" id="L1168">		String venID = oadrCreatedReport.getVenID();</span>
<span class="fc" id="L1169">		String requestID = oadrCreatedReport.getEiResponse().getRequestID();</span>
<span class="fc bfc" id="L1170" title="All 2 branches covered.">		if (!username.equals(venID)) {</span>
<span class="fc" id="L1171">			EiResponseType mismatchCredentialsVenIdResponse = Oadr20bResponseBuilders</span>
<span class="fc" id="L1172">					.newOadr20bEiResponseMismatchUsernameVenIdBuilder(requestID, username, venID).build();</span>
<span class="fc" id="L1173">			throw new Oadr20bCreatedReportApplicationLayerException(</span>
<span class="fc" id="L1174">					mismatchCredentialsVenIdResponse.getResponseDescription(),</span>
<span class="fc" id="L1175">					Oadr20bResponseBuilders.newOadr20bResponseBuilder(mismatchCredentialsVenIdResponse, venID).build());</span>
		}
<span class="fc" id="L1177">	}</span>

	public void checkMatchUsernameWithRequestVenId(String username, OadrCreateReportType oadrCreateReport)
			throws Oadr20bCreateReportApplicationLayerException {
<span class="fc" id="L1181">		String venID = oadrCreateReport.getVenID();</span>
<span class="fc" id="L1182">		String requestID = oadrCreateReport.getRequestID();</span>
<span class="fc bfc" id="L1183" title="All 2 branches covered.">		if (!username.equals(venID)) {</span>
<span class="fc" id="L1184">			EiResponseType mismatchCredentialsVenIdResponse = Oadr20bResponseBuilders</span>
<span class="fc" id="L1185">					.newOadr20bEiResponseMismatchUsernameVenIdBuilder(requestID, username, venID).build();</span>
<span class="fc" id="L1186">			throw new Oadr20bCreateReportApplicationLayerException(</span>
<span class="fc" id="L1187">					mismatchCredentialsVenIdResponse.getResponseDescription(),</span>
					Oadr20bEiReportBuilders
<span class="fc" id="L1189">							.newOadr20bCreatedReportBuilder(requestID,</span>
<span class="fc" id="L1190">									Integer.valueOf(mismatchCredentialsVenIdResponse.getResponseCode()), venID)</span>
<span class="fc" id="L1191">							.build());</span>
		}
<span class="fc" id="L1193">	}</span>

	public void checkMatchUsernameWithRequestVenId(String username, OadrCancelReportType oadrCancelReport)
			throws Oadr20bCancelReportApplicationLayerException {
<span class="fc" id="L1197">		String venID = oadrCancelReport.getVenID();</span>
<span class="fc" id="L1198">		String requestID = oadrCancelReport.getRequestID();</span>
<span class="fc bfc" id="L1199" title="All 2 branches covered.">		if (!username.equals(venID)) {</span>
<span class="fc" id="L1200">			EiResponseType mismatchCredentialsVenIdResponse = Oadr20bResponseBuilders</span>
<span class="fc" id="L1201">					.newOadr20bEiResponseMismatchUsernameVenIdBuilder(requestID, username, venID).build();</span>
<span class="fc" id="L1202">			throw new Oadr20bCancelReportApplicationLayerException(</span>
<span class="fc" id="L1203">					mismatchCredentialsVenIdResponse.getResponseDescription(),</span>
					Oadr20bEiReportBuilders
<span class="fc" id="L1205">							.newOadr20bCanceledReportBuilder(requestID,</span>
<span class="fc" id="L1206">									Integer.valueOf(mismatchCredentialsVenIdResponse.getResponseCode()), venID)</span>
<span class="fc" id="L1207">							.build());</span>
		}
<span class="fc" id="L1209">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>