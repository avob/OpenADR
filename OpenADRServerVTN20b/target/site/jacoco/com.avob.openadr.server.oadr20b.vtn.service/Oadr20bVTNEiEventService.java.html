<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Oadr20bVTNEiEventService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">OpenADRServerVTN20b</a> &gt; <a href="index.source.html" class="el_package">com.avob.openadr.server.oadr20b.vtn.service</a> &gt; <span class="el_source">Oadr20bVTNEiEventService.java</span></div><h1>Oadr20bVTNEiEventService.java</h1><pre class="source lang-java linenums">package com.avob.openadr.server.oadr20b.vtn.service;

import java.util.Arrays;
import java.util.Date;
import java.util.List;

import javax.annotation.Resource;
import javax.xml.bind.JAXBElement;
import javax.xml.bind.JAXBException;
import javax.xml.datatype.DatatypeConfigurationException;
import javax.xml.datatype.DatatypeFactory;
import javax.xml.datatype.Duration;

import org.eclipse.jetty.http.HttpStatus;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import com.avob.openadr.model.oadr20a.builders.Oadr20aBuilders;
import com.avob.openadr.model.oadr20b.Oadr20bFactory;
import com.avob.openadr.model.oadr20b.Oadr20bJAXBContext;
import com.avob.openadr.model.oadr20b.builders.Oadr20bEiBuilders;
import com.avob.openadr.model.oadr20b.builders.Oadr20bEiEventBuilders;
import com.avob.openadr.model.oadr20b.builders.Oadr20bResponseBuilders;
import com.avob.openadr.model.oadr20b.builders.eievent.Oadr20bDistributeEventBuilder;
import com.avob.openadr.model.oadr20b.builders.eievent.Oadr20bDistributeEventOadrEventBuilder;
import com.avob.openadr.model.oadr20b.builders.eievent.Oadr20bEiActivePeriodTypeBuilder;
import com.avob.openadr.model.oadr20b.builders.eipayload.Oadr20bEiTargetTypeBuilder;
import com.avob.openadr.model.oadr20b.ei.EiActivePeriodType;
import com.avob.openadr.model.oadr20b.ei.EiEventSignalType;
import com.avob.openadr.model.oadr20b.ei.EiEventSignalsType;
import com.avob.openadr.model.oadr20b.ei.EiEventType;
import com.avob.openadr.model.oadr20b.ei.EiResponseType;
import com.avob.openadr.model.oadr20b.ei.EiTargetType;
import com.avob.openadr.model.oadr20b.ei.EventDescriptorType;
import com.avob.openadr.model.oadr20b.ei.EventResponses.EventResponse;
import com.avob.openadr.model.oadr20b.ei.EventStatusEnumeratedType;
import com.avob.openadr.model.oadr20b.ei.IntervalType;
import com.avob.openadr.model.oadr20b.ei.OptTypeType;
import com.avob.openadr.model.oadr20b.ei.PayloadBaseType;
import com.avob.openadr.model.oadr20b.ei.PayloadFloatType;
import com.avob.openadr.model.oadr20b.ei.QualifiedEventIDType;
import com.avob.openadr.model.oadr20b.ei.SignalPayloadType;
import com.avob.openadr.model.oadr20b.ei.SignalTypeEnumeratedType;
import com.avob.openadr.model.oadr20b.exception.Oadr20bMarshalException;
import com.avob.openadr.model.oadr20b.exception.Oadr20bUnmarshalException;
import com.avob.openadr.model.oadr20b.exception.Oadr20bXMLSignatureException;
import com.avob.openadr.model.oadr20b.oadr.OadrCreatedEventType;
import com.avob.openadr.model.oadr20b.oadr.OadrDistributeEventType;
import com.avob.openadr.model.oadr20b.oadr.OadrPayloadResourceStatusType;
import com.avob.openadr.model.oadr20b.oadr.OadrRequestEventType;
import com.avob.openadr.model.oadr20b.oadr.OadrResponseType;
import com.avob.openadr.model.oadr20b.pyld.EiCreatedEvent;
import com.avob.openadr.model.oadr20b.strm.StreamPayloadBaseType;
import com.avob.openadr.model.oadr20b.xcal.Dtstart;
import com.avob.openadr.model.oadr20b.xcal.DurationPropType;
import com.avob.openadr.server.common.vtn.exception.OadrVTNInitializationException;
import com.avob.openadr.server.common.vtn.models.demandresponseevent.DemandResponseEvent;
import com.avob.openadr.server.common.vtn.models.demandresponseevent.DemandResponseEventStateEnum;
import com.avob.openadr.server.common.vtn.models.ven.Ven;
import com.avob.openadr.server.common.vtn.models.venmarketcontext.VenMarketContext;
import com.avob.openadr.server.common.vtn.service.DemandResponseEventService;
import com.avob.openadr.server.common.vtn.service.VenRequestCountService;
import com.avob.openadr.server.common.vtn.service.VenService;
import com.avob.openadr.server.oadr20a.vtn.exception.Oadr20aCreatedEventApplicationLayerException;
import com.avob.openadr.server.oadr20a.vtn.service.Oadr20aVTNEiEventService;
import com.avob.openadr.server.oadr20b.vtn.converter.OptConverter;
import com.avob.openadr.server.oadr20b.vtn.exception.eievent.Oadr20bCreatedEventApplicationLayerException;
import com.avob.openadr.server.oadr20b.vtn.exception.eievent.Oadr20bRequestEventApplicationLayerException;

@Service
public class Oadr20bVTNEiEventService {

<span class="fc" id="L75">    private static final Logger LOGGER = LoggerFactory.getLogger(Oadr20aVTNEiEventService.class);</span>

    private static final String SIMPLE_SIGNAL_NAME = &quot;simple&quot;;

    @Value(&quot;${oadr.vtnid}&quot;)
    private String vtnId;

    @Resource
    private DemandResponseEventService demandResponseEventService;

    @Resource
    private VenRequestCountService venRequestCountService;

    @Resource
    private VenService venService;

    @Resource
    private XmlSignatureService xmlSignatureService;

    /**
     * xml date/duration factory
     */
    private static DatatypeFactory datatypeFactory;

    static {
        try {
<span class="fc" id="L101">            datatypeFactory = DatatypeFactory.newInstance();</span>
<span class="nc" id="L102">        } catch (DatatypeConfigurationException e) {</span>
<span class="nc" id="L103">            throw new OadrVTNInitializationException(e);</span>
<span class="fc" id="L104">        }</span>
<span class="fc" id="L105">    }</span>

    private Oadr20bJAXBContext jaxbContext;

<span class="fc" id="L109">    public Oadr20bVTNEiEventService() throws JAXBException {</span>
<span class="fc" id="L110">        jaxbContext = Oadr20bJAXBContext.getInstance();</span>
<span class="fc" id="L111">    }</span>

    public void checkMatchUsernameWithRequestVenId(String username, OadrCreatedEventType oadrCreatedEvent)
            throws Oadr20bCreatedEventApplicationLayerException {
<span class="fc bfc" id="L115" title="All 2 branches covered.">        if (!username.equals(oadrCreatedEvent.getEiCreatedEvent().getVenID())) {</span>
<span class="fc" id="L116">            String requestID = oadrCreatedEvent.getEiCreatedEvent().getEiResponse().getRequestID();</span>
<span class="fc" id="L117">            EiResponseType mismatchCredentialsVenIdResponse = Oadr20bResponseBuilders</span>
<span class="fc" id="L118">                    .newOadr20bEiResponseMismatchUsernameVenIdBuilder(requestID, username,</span>
<span class="fc" id="L119">                            oadrCreatedEvent.getEiCreatedEvent().getVenID())</span>
<span class="fc" id="L120">                    .build();</span>
<span class="fc" id="L121">            throw new Oadr20bCreatedEventApplicationLayerException(</span>
<span class="fc" id="L122">                    mismatchCredentialsVenIdResponse.getResponseDescription(), Oadr20bResponseBuilders</span>
<span class="fc" id="L123">                            .newOadr20bResponseBuilder(mismatchCredentialsVenIdResponse, username).build());</span>
        }
<span class="fc" id="L125">    }</span>

    public void checkMatchUsernameWithRequestVenId(String username, OadrRequestEventType oadrRequestEvent)
            throws Oadr20bRequestEventApplicationLayerException {
<span class="fc" id="L129">        String requestID = oadrRequestEvent.getEiRequestEvent().getRequestID();</span>
<span class="fc" id="L130">        String venID = oadrRequestEvent.getEiRequestEvent().getVenID();</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">        if (!username.equals(venID)) {</span>
<span class="fc" id="L132">            EiResponseType mismatchCredentialsVenIdResponse = Oadr20bResponseBuilders</span>
<span class="fc" id="L133">                    .newOadr20bEiResponseMismatchUsernameVenIdBuilder(requestID, username, venID).build();</span>
<span class="fc" id="L134">            throw new Oadr20bRequestEventApplicationLayerException(</span>
<span class="fc" id="L135">                    mismatchCredentialsVenIdResponse.getResponseDescription(),</span>
<span class="fc" id="L136">                    Oadr20bEiEventBuilders.newOadr20bDistributeEventBuilder(vtnId, requestID)</span>
<span class="fc" id="L137">                            .withEiResponse(mismatchCredentialsVenIdResponse).build());</span>
        }
<span class="fc" id="L139">    }</span>

    private void processEventResponseFromOadrCreatedEvent(Ven ven, EventResponse response)
            throws Oadr20aCreatedEventApplicationLayerException {
<span class="fc" id="L143">        String requestID = response.getRequestID();</span>

<span class="fc" id="L145">        QualifiedEventIDType qualifiedEventID = response.getQualifiedEventID();</span>
<span class="fc" id="L146">        String eventID = qualifiedEventID.getEventID();</span>
<span class="fc" id="L147">        long modificationNumber = qualifiedEventID.getModificationNumber();</span>

<span class="fc" id="L149">        DemandResponseEvent findById = demandResponseEventService.findById(Long.parseLong(eventID));</span>

<span class="fc bfc" id="L151" title="All 2 branches covered.">        if (findById == null) {</span>
<span class="fc" id="L152">            String description = &quot;eiCreatedEvent:unknown event with id: &quot; + eventID;</span>
<span class="fc" id="L153">            throw new Oadr20aCreatedEventApplicationLayerException(description,</span>
<span class="fc" id="L154">                    Oadr20aBuilders.newOadr20aResponseBuilder(requestID, HttpStatus.NOT_FOUND_404)</span>
<span class="fc" id="L155">                            .withDescription(description).build());</span>
        }

<span class="fc bfc" id="L158" title="All 2 branches covered.">        if (findById.getModificationNumber() != modificationNumber) {</span>

<span class="fc" id="L160">            String description = &quot;eiCreatedEvent:mismatch modification number for event with id: &quot; + eventID;</span>
<span class="fc" id="L161">            throw new Oadr20aCreatedEventApplicationLayerException(description,</span>
<span class="fc" id="L162">                    Oadr20aBuilders.newOadr20aResponseBuilder(requestID, HttpStatus.NOT_ACCEPTABLE_406)</span>
<span class="fc" id="L163">                            .withDescription(description).build());</span>
        }

<span class="fc" id="L166">        int responseCode = Integer.valueOf(response.getResponseCode());</span>

<span class="pc bpc" id="L168" title="1 of 2 branches missed.">        if (HttpStatus.OK_200 == responseCode) {</span>
<span class="fc" id="L169">            OptTypeType optType = response.getOptType();</span>
<span class="fc" id="L170">            demandResponseEventService.updateVenOpt(Long.parseLong(eventID), modificationNumber, ven.getUsername(),</span>
<span class="fc" id="L171">                    OptConverter.convert(optType));</span>
        }
        // TODO bertrand: if responseCode is not OK, that's mean VEN somehow
        // could not understand previously sent DREvent. Maybe we should here
        // invalidate this event for this VEN or something...

<span class="fc" id="L177">    }</span>

    public String oadrCreatedEvent(OadrCreatedEventType event, boolean signed)
            throws Oadr20bCreatedEventApplicationLayerException, Oadr20bXMLSignatureException, Oadr20bMarshalException {
<span class="fc" id="L181">        EiCreatedEvent eiCreatedEvent = event.getEiCreatedEvent();</span>

<span class="fc" id="L183">        String requestID = eiCreatedEvent.getEiResponse().getRequestID();</span>

<span class="fc" id="L185">        String venID = eiCreatedEvent.getVenID();</span>

<span class="fc" id="L187">        Ven ven = venService.findOneByUsername(venID);</span>

<span class="pc bpc" id="L189" title="4 of 6 branches missed.">        if (ven.getXmlSignature() != null &amp;&amp; ven.getXmlSignature() &amp;&amp; !signed) {</span>
<span class="nc" id="L190">            EiResponseType xmlSignatureRequiredButAbsent = Oadr20bResponseBuilders</span>
<span class="nc" id="L191">                    .newOadr20bEiResponseXmlSignatureRequiredButAbsentBuilder(requestID, venID).build();</span>
<span class="nc" id="L192">            throw new Oadr20bCreatedEventApplicationLayerException(</span>
<span class="nc" id="L193">                    xmlSignatureRequiredButAbsent.getResponseDescription(),</span>
<span class="nc" id="L194">                    Oadr20bResponseBuilders.newOadr20bResponseBuilder(xmlSignatureRequiredButAbsent, venID).build());</span>
        }

<span class="fc" id="L197">        int responseCode = HttpStatus.OK_200;</span>
<span class="fc bfc" id="L198" title="All 2 branches covered.">        for (EventResponse response : eiCreatedEvent.getEventResponses().getEventResponse()) {</span>
            try {
<span class="fc" id="L200">                processEventResponseFromOadrCreatedEvent(ven, response);</span>
<span class="fc" id="L201">            } catch (Oadr20aCreatedEventApplicationLayerException e) {</span>
<span class="fc" id="L202">                LOGGER.warn(e.getMessage(), e);</span>
<span class="fc" id="L203">                responseCode = HttpStatus.NOT_ACCEPTABLE_406;</span>
<span class="fc" id="L204">            }</span>
<span class="fc" id="L205">        }</span>

<span class="fc" id="L207">        OadrResponseType response = Oadr20bResponseBuilders.newOadr20bResponseBuilder(requestID, responseCode, venID)</span>
<span class="fc" id="L208">                .build();</span>
<span class="pc bpc" id="L209" title="1 of 2 branches missed.">        if (signed) {</span>
<span class="nc" id="L210">            return xmlSignatureService.sign(response);</span>
        } else {
<span class="fc" id="L212">            return jaxbContext.marshalRoot(response);</span>
        }
    }

    public String oadrRequestEvent(OadrRequestEventType event, boolean signed)
            throws Oadr20bRequestEventApplicationLayerException, Oadr20bXMLSignatureException, Oadr20bMarshalException {

<span class="fc" id="L219">        String venRequestID = event.getEiRequestEvent().getRequestID();</span>

<span class="fc" id="L221">        Long replyLimit = event.getEiRequestEvent().getReplyLimit();</span>

<span class="fc" id="L223">        String venID = event.getEiRequestEvent().getVenID();</span>

<span class="fc" id="L225">        Ven ven = venService.findOneByUsername(venID);</span>

<span class="pc bpc" id="L227" title="4 of 6 branches missed.">        if (ven.getXmlSignature() != null &amp;&amp; ven.getXmlSignature() &amp;&amp; !signed) {</span>
<span class="nc" id="L228">            EiResponseType xmlSignatureRequiredButAbsent = Oadr20bResponseBuilders</span>
<span class="nc" id="L229">                    .newOadr20bEiResponseXmlSignatureRequiredButAbsentBuilder(venRequestID, venID).build();</span>
<span class="nc" id="L230">            throw new Oadr20bRequestEventApplicationLayerException(</span>
<span class="nc" id="L231">                    xmlSignatureRequiredButAbsent.getResponseDescription(),</span>
<span class="nc" id="L232">                    Oadr20bEiEventBuilders.newOadr20bDistributeEventBuilder(vtnId, venRequestID)</span>
<span class="nc" id="L233">                            .withEiResponse(xmlSignatureRequiredButAbsent).build());</span>
        }

<span class="fc" id="L236">        List&lt;DemandResponseEvent&gt; findByVenId = demandResponseEventService.findToSentEventByVen(ven, replyLimit);</span>

        // oadr events
<span class="fc" id="L239">        OadrDistributeEventType response = null;</span>
<span class="pc bpc" id="L240" title="1 of 4 branches missed.">        if (findByVenId == null || findByVenId.isEmpty()) {</span>
<span class="fc" id="L241">            Long andIncrease = venRequestCountService.getAndIncrease(venID);</span>
<span class="fc" id="L242">            EiResponseType eiResponse = Oadr20bResponseBuilders</span>
<span class="fc" id="L243">                    .newOadr20bEiResponseBuilder(venRequestID, HttpStatus.OK_200).build();</span>
<span class="fc" id="L244">            response = Oadr20bEiEventBuilders.newOadr20bDistributeEventBuilder(vtnId, Long.toString(andIncrease))</span>
<span class="fc" id="L245">                    .withEiResponse(eiResponse).build();</span>
<span class="fc" id="L246">        } else {</span>
<span class="fc" id="L247">            response = createOadrDistributeEventPayload(venID, venRequestID, findByVenId);</span>
        }
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">        if (signed) {</span>
<span class="nc" id="L250">            return xmlSignatureService.sign(response);</span>
        } else {
<span class="fc" id="L252">            return jaxbContext.marshalRoot(response);</span>
        }

    }

    public OadrDistributeEventType createOadrDistributeEventPayload(String venId, List&lt;DemandResponseEvent&gt; events) {
<span class="nc" id="L258">        return createOadrDistributeEventPayload(venId, &quot;&quot;, events);</span>
    }

    private OadrDistributeEventType createOadrDistributeEventPayload(String venId, String eiResponseRequestId,
            List&lt;DemandResponseEvent&gt; events) {
<span class="fc" id="L263">        Long now = System.currentTimeMillis();</span>
        // vtn request id
<span class="fc" id="L265">        Long andIncrease = venRequestCountService.getAndIncrease(venId);</span>
<span class="fc" id="L266">        EiResponseType eiResponse = Oadr20bResponseBuilders</span>
<span class="fc" id="L267">                .newOadr20bEiResponseBuilder(eiResponseRequestId, HttpStatus.OK_200).build();</span>
<span class="fc" id="L268">        Oadr20bDistributeEventBuilder builder = Oadr20bEiEventBuilders</span>
<span class="fc" id="L269">                .newOadr20bDistributeEventBuilder(vtnId, Long.toString(andIncrease)).withEiResponse(eiResponse);</span>

<span class="fc bfc" id="L271" title="All 2 branches covered.">        for (DemandResponseEvent drEvent : events) {</span>
<span class="fc" id="L272">            EventDescriptorType createEventDescriptor = createEventDescriptor(drEvent);</span>

<span class="fc bfc" id="L274" title="All 2 branches covered.">            boolean needResponse = !demandResponseEventService.hasResponded(venId, drEvent);</span>

<span class="fc bfc" id="L276" title="All 2 branches covered.">            if (drEvent.getEvent() == null) {</span>
<span class="fc" id="L277">                builder.addOadrEvent(Oadr20bEiEventBuilders.newOadr20bDistributeEventOadrEventBuilder()</span>
<span class="fc" id="L278">                        .withEventDescriptor(createEventDescriptor).withActivePeriod(createActivePeriod(drEvent))</span>
<span class="fc" id="L279">                        .addEiEventSignal(createEventSignal(drEvent, createEventDescriptor))</span>
<span class="fc" id="L280">                        .withEiTarget(createEventTarget(venId)).withResponseRequired(needResponse).build());</span>
            } else {
                Object unmarshal;
                try {
<span class="fc" id="L284">                    unmarshal = jaxbContext.unmarshal(drEvent.getEvent(), false);</span>
<span class="pc bpc" id="L285" title="1 of 2 branches missed.">                    if (unmarshal instanceof EiEventType) {</span>

<span class="fc" id="L287">                        EiEventType eventType = (EiEventType) unmarshal;</span>
<span class="fc" id="L288">                        EiEventSignalsType eiEventSignals = eventType.getEiEventSignals();</span>

<span class="fc" id="L290">                        setSignalsCurrentValue(eiEventSignals, createEventDescriptor, now);</span>

<span class="fc" id="L292">                        Oadr20bDistributeEventOadrEventBuilder oadrEventBuilder = Oadr20bEiEventBuilders</span>
<span class="fc" id="L293">                                .newOadr20bDistributeEventOadrEventBuilder(eventType)</span>
<span class="fc" id="L294">                                .withEventDescriptor(createEventDescriptor)</span>
//                                .addEiEventSignal(eiEventSignals.getEiEventSignal())
<span class="fc" id="L296">                                .withEiEventBaseline(eiEventSignals.getEiEventBaseline())</span>
<span class="fc" id="L297">                                .withEiTarget(eventType.getEiTarget())</span>
<span class="fc" id="L298">                                .withResponseRequired(needResponse);</span>

<span class="fc" id="L300">                        builder.addOadrEvent(oadrEventBuilder.build());</span>
                    }

<span class="nc" id="L303">                } catch (Oadr20bUnmarshalException e) {</span>
                    // TODO bertrand: do something ? It could be normal not to
                    // be able to unmarshal this because of profile b events
<span class="nc" id="L306">                    LOGGER.warn(&quot;&quot;, e);</span>
<span class="fc" id="L307">                }</span>

            }

<span class="fc" id="L311">        }</span>

<span class="fc" id="L313">        return builder.build();</span>
    }

    /**
     * @param drEvent
     * @return
     * @throws DatatypeConfigurationException
     */
    private EiActivePeriodType createActivePeriod(DemandResponseEvent drEvent) {

<span class="fc" id="L323">        Long start = drEvent.getStart();</span>
<span class="fc" id="L324">        String xmlDuration = drEvent.getDuration();</span>
<span class="fc" id="L325">        String toleranceDuration = drEvent.getToleranceDuration();</span>
<span class="fc" id="L326">        String rampUpDuration = drEvent.getRampUpDuration();</span>
<span class="fc" id="L327">        String recoveryDuration = drEvent.getRecoveryDuration();</span>
<span class="fc" id="L328">        String notificationDuration = drEvent.getNotificationDuration();</span>

<span class="fc" id="L330">        Oadr20bEiActivePeriodTypeBuilder builder = Oadr20bEiEventBuilders.newOadr20bEiActivePeriodTypeBuilder(start,</span>
                xmlDuration, toleranceDuration, notificationDuration);

<span class="fc bfc" id="L333" title="All 2 branches covered.">        if (rampUpDuration != null) {</span>
<span class="fc" id="L334">            builder.withRampUp(rampUpDuration);</span>
        }

<span class="fc bfc" id="L337" title="All 2 branches covered.">        if (recoveryDuration != null) {</span>
<span class="fc" id="L338">            builder.withRecovery(recoveryDuration);</span>
        }

<span class="fc" id="L341">        return builder.build();</span>

    }

    /**
     * Calling ven is the only target onf the drEvent
     * 
     * @param drEvent
     * @return
     */
    private EiTargetType createEventTarget(String callingVenUsername) {
<span class="fc" id="L352">        Oadr20bEiTargetTypeBuilder builder = Oadr20bEiBuilders.newOadr20bEiTargetTypeBuilder();</span>
<span class="fc" id="L353">        builder.addVenId(callingVenUsername);</span>
<span class="fc" id="L354">        return builder.build();</span>
    }

    private void setSignalsCurrentValue(EiEventSignalsType eiEventSignals, EventDescriptorType descriptor,
            Long nowTimestamp) {

<span class="fc bfc" id="L360" title="All 2 branches covered.">        for (EiEventSignalType eiEventSignalType : eiEventSignals.getEiEventSignal()) {</span>

            // the current value of a signal is undefined when signal is not
            // active, except for a &quot;simple&quot; signal which default to &quot;0&quot; (normal
            // behavior)
<span class="fc" id="L365">            Float currentValue = null;</span>
<span class="pc bpc" id="L366" title="1 of 2 branches missed.">            if (SIMPLE_SIGNAL_NAME.equals(eiEventSignalType.getSignalName().trim())) {</span>
<span class="fc" id="L367">                currentValue = 0F;</span>
            }

<span class="fc bfc" id="L370" title="All 2 branches covered.">            for (IntervalType intervalType : eiEventSignalType.getIntervals().getInterval()) {</span>

<span class="fc" id="L372">                Dtstart dtstart = intervalType.getDtstart();</span>
<span class="fc" id="L373">                DurationPropType duration = intervalType.getDuration();</span>

<span class="fc" id="L375">                Long start = Oadr20bFactory.xmlCalendarToTimestamp(dtstart.getDateTime());</span>
<span class="fc" id="L376">                Long end = Oadr20bFactory.addXMLDurationToTimestamp(start, duration.getDuration());</span>

<span class="fc" id="L378">                List&lt;JAXBElement&lt;? extends StreamPayloadBaseType&gt;&gt; streamPayloadBases = intervalType</span>
<span class="fc" id="L379">                        .getStreamPayloadBase();</span>
<span class="fc bfc" id="L380" title="All 2 branches covered.">                for (JAXBElement&lt;? extends StreamPayloadBaseType&gt; streamPayloadBase : streamPayloadBases) {</span>
<span class="pc bpc" id="L381" title="1 of 2 branches missed.">                    if (streamPayloadBase.getDeclaredType().equals(SignalPayloadType.class)) {</span>
<span class="fc" id="L382">                        SignalPayloadType value = (SignalPayloadType) streamPayloadBase.getValue();</span>
<span class="fc" id="L383">                        JAXBElement&lt;? extends PayloadBaseType&gt; payloadBase = value.getPayloadBase();</span>
<span class="pc bpc" id="L384" title="1 of 2 branches missed.">                        if (payloadBase.getDeclaredType().equals(PayloadFloatType.class)) {</span>

<span class="fc" id="L386">                            PayloadFloatType payloadFloatType = (PayloadFloatType) payloadBase.getValue();</span>
                            // if event and interval is active
<span class="pc bpc" id="L388" title="1 of 2 branches missed.">                            if (EventStatusEnumeratedType.ACTIVE.equals(descriptor.getEventStatus())</span>
<span class="pc bpc" id="L389" title="4 of 6 branches missed.">                                    &amp;&amp; start &lt;= nowTimestamp &amp;&amp; (end &gt; nowTimestamp || end == null)) {</span>
<span class="fc" id="L390">                                currentValue = payloadFloatType.getValue();</span>
                            }

<span class="pc bnc" id="L393" title="All 2 branches missed.">                        } else if (payloadBase.getDeclaredType().equals(OadrPayloadResourceStatusType.class)) {</span>
                            // TODO bertrand: deal with those kind of interval
                        }

                    }
<span class="fc" id="L398">                }</span>

<span class="fc" id="L400">            }</span>
<span class="pc bpc" id="L401" title="1 of 2 branches missed.">            if (currentValue != null) {</span>
<span class="fc" id="L402">                eiEventSignalType.setCurrentValue(Oadr20bFactory.createCurrentValueType(currentValue));</span>
            }
<span class="fc" id="L404">        }</span>
<span class="fc" id="L405">    }</span>

    /**
     * create event signals for a specific DREvent
     * 
     * current implementation only specified 1 signal with one interval
     * 
     * @param drEvent
     * @return
     */
    private EiEventSignalType createEventSignal(DemandResponseEvent drEvent, EventDescriptorType descriptor) {

<span class="fc" id="L417">        Long start = drEvent.getStart();</span>
<span class="fc" id="L418">        String signalId = &quot;0&quot;;</span>
        // signal name: MUST be 'simple' for 20a spec
<span class="fc" id="L420">        String signalName = SIMPLE_SIGNAL_NAME;</span>
<span class="fc" id="L421">        String intervalId = &quot;0&quot;;</span>
<span class="fc" id="L422">        String xmlDuration = drEvent.getDuration();</span>
<span class="fc" id="L423">        SignalTypeEnumeratedType signalType = SignalTypeEnumeratedType.LEVEL;</span>

        // signal value: either 0,1,2,3 for 20a spec
        // spec conformance 14: current value must be set to 0 when event is not
        // active
<span class="fc" id="L428">        float currentValue = 0F;</span>

<span class="fc bfc" id="L430" title="All 2 branches covered.">        if (EventStatusEnumeratedType.ACTIVE.equals(descriptor.getEventStatus())) {</span>
<span class="fc" id="L431">            currentValue = (float) drEvent.getValue().getValue();</span>
        }
<span class="fc" id="L433">        List&lt;Float&gt; currentValues = Arrays.asList(currentValue);</span>

<span class="fc" id="L435">        IntervalType interval = Oadr20bEiBuilders</span>
<span class="fc" id="L436">                .newOadr20bSignalIntervalTypeBuilder(intervalId, start, xmlDuration, currentValues).build();</span>

<span class="fc" id="L438">        return Oadr20bEiEventBuilders.newOadr20bEiEventSignalTypeBuilder(signalId, signalName, signalType, currentValue)</span>
<span class="fc" id="L439">                .addInterval(interval).build();</span>

    }

    private EventStatusEnumeratedType getOadrEventStatus(Date now, long start, long end, long startNotification,
            String rampUpDuration) {
<span class="fc" id="L445">        EventStatusEnumeratedType status = null;</span>
<span class="fc" id="L446">        Date dateStart = new Date();</span>
<span class="fc" id="L447">        dateStart.setTime(start);</span>

<span class="fc" id="L449">        Date dateEnd = new Date();</span>
<span class="fc" id="L450">        dateEnd.setTime(end);</span>

<span class="fc" id="L452">        Date dateStartNotification = new Date();</span>
<span class="fc" id="L453">        dateStartNotification.setTime(startNotification);</span>

<span class="fc" id="L455">        Date dateStartNear = new Date();</span>
<span class="fc" id="L456">        dateStartNear.setTime(start);</span>
<span class="fc bfc" id="L457" title="All 2 branches covered.">        if (rampUpDuration != null) {</span>
<span class="fc" id="L458">            Duration newDuration = datatypeFactory.newDuration(rampUpDuration);</span>
<span class="fc" id="L459">            long timeInMillis = newDuration.getTimeInMillis(dateStart);</span>
<span class="fc" id="L460">            dateStartNear.setTime(start - timeInMillis);</span>
        }

<span class="pc bpc" id="L463" title="2 of 4 branches missed.">        if (now.equals(dateEnd) || now.after(dateEnd)) {</span>
<span class="nc" id="L464">            status = EventStatusEnumeratedType.COMPLETED;</span>
<span class="pc bpc" id="L465" title="2 of 6 branches missed.">        } else if (now.equals(dateStart) || (now.before(dateEnd) &amp;&amp; now.after(dateStart))) {</span>
<span class="fc" id="L466">            status = EventStatusEnumeratedType.ACTIVE;</span>
<span class="pc bpc" id="L467" title="2 of 6 branches missed.">        } else if (now.equals(dateStartNear) || (now.before(dateStart) &amp;&amp; now.after(dateStartNear))) {</span>
<span class="fc" id="L468">            status = EventStatusEnumeratedType.NEAR;</span>
<span class="pc bpc" id="L469" title="1 of 2 branches missed.">        } else if (now.equals(dateStartNotification)</span>
<span class="pc bpc" id="L470" title="2 of 4 branches missed.">                || (now.before(dateStartNear) &amp;&amp; now.after(dateStartNotification))) {</span>
<span class="fc" id="L471">            status = EventStatusEnumeratedType.FAR;</span>
        } else {
<span class="nc" id="L473">            status = EventStatusEnumeratedType.NONE;</span>
        }

<span class="fc" id="L476">        return status;</span>
    }

    /**
     * create EventDescriptorType for a specific DemandResponseEvent
     * 
     * @param drEvent
     * @return
     * @throws DatatypeConfigurationException
     */
    private EventDescriptorType createEventDescriptor(DemandResponseEvent drEvent) {

<span class="fc" id="L488">        String eventId = String.valueOf(drEvent.getId());</span>
<span class="fc" id="L489">        Long start = drEvent.getStart();</span>
<span class="fc" id="L490">        Long createdTimestamp = drEvent.getCreatedTimestamp();</span>
<span class="fc" id="L491">        Long end = drEvent.getEnd();</span>
<span class="fc" id="L492">        Long startNotification = drEvent.getStartNotification();</span>
<span class="fc" id="L493">        String rampUpDuration = drEvent.getRampUpDuration();</span>
<span class="fc" id="L494">        VenMarketContext marketContext = drEvent.getMarketContext();</span>
<span class="fc" id="L495">        DemandResponseEventStateEnum state = drEvent.getState();</span>

<span class="fc" id="L497">        long priority = drEvent.getPriority();</span>
<span class="fc" id="L498">        boolean testEvent = drEvent.isTestEvent();</span>
<span class="fc" id="L499">        long modificationNumber = drEvent.getModificationNumber();</span>
<span class="fc" id="L500">        String vtnComment = drEvent.getVtnComment();</span>

        // event status
<span class="fc" id="L503">        Date now = new Date();</span>
<span class="fc" id="L504">        EventStatusEnumeratedType status = null;</span>
<span class="fc bfc" id="L505" title="All 2 branches covered.">        if (DemandResponseEventStateEnum.ACTIVE.equals(state)) {</span>
<span class="fc" id="L506">            status = getOadrEventStatus(now, start, end, startNotification, rampUpDuration);</span>
<span class="pc bpc" id="L507" title="1 of 2 branches missed.">        } else if (DemandResponseEventStateEnum.CANCELED.equals(state)) {</span>
<span class="fc" id="L508">            status = EventStatusEnumeratedType.CANCELLED;</span>
        }

<span class="fc" id="L511">        return Oadr20bEiEventBuilders</span>
<span class="fc" id="L512">                .newOadr20bEventDescriptorTypeBuilder(createdTimestamp, eventId, modificationNumber,</span>
<span class="fc" id="L513">                        marketContext.getName(), status)</span>
<span class="fc" id="L514">                .withPriority(priority).withTestEvent(testEvent).withVtnComment(vtnComment).build();</span>

    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>