<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DemandResponseEventService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">OpenADRServerVTNCommon</a> &gt; <a href="index.source.html" class="el_package">com.avob.openadr.server.common.vtn.service</a> &gt; <span class="el_source">DemandResponseEventService.java</span></div><h1>DemandResponseEventService.java</h1><pre class="source lang-java linenums">package com.avob.openadr.server.common.vtn.service;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Date;
import java.util.List;
import java.util.concurrent.Executor;

import javax.annotation.Resource;
import javax.xml.datatype.DatatypeConfigurationException;
import javax.xml.datatype.DatatypeFactory;
import javax.xml.datatype.Duration;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.avob.openadr.server.common.vtn.exception.OadrVTNInitializationException;
import com.avob.openadr.server.common.vtn.models.demandresponseevent.DemandResponseEvent;
import com.avob.openadr.server.common.vtn.models.demandresponseevent.DemandResponseEventDao;
import com.avob.openadr.server.common.vtn.models.demandresponseevent.DemandResponseEventOadrProfileEnum;
import com.avob.openadr.server.common.vtn.models.demandresponseevent.DemandResponseEventOptEnum;
import com.avob.openadr.server.common.vtn.models.demandresponseevent.DemandResponseEventSimpleValueEnum;
import com.avob.openadr.server.common.vtn.models.demandresponseevent.DemandResponseEventStateEnum;
import com.avob.openadr.server.common.vtn.models.ven.Ven;
import com.avob.openadr.server.common.vtn.models.ven.VenDao;
import com.avob.openadr.server.common.vtn.models.vendemandresponseevent.VenDemandResponseEvent;
import com.avob.openadr.server.common.vtn.models.vendemandresponseevent.VenDemandResponseEventDao;
import com.avob.openadr.server.common.vtn.models.venmarketcontext.VenMarketContext;
import com.avob.openadr.server.common.vtn.service.push.DemandResponseEventPublisher;
import com.google.common.collect.Lists;

@Service
@Transactional
<span class="fc" id="L39">public class DemandResponseEventService {</span>

<span class="fc" id="L41">	private static final Logger LOGGER = LoggerFactory.getLogger(DemandResponseEventService.class);</span>

	@Value(&quot;${oadr.supportPush:#{false}}&quot;)
	private Boolean supportPush;

	@Resource
	private VenDao venDao;

	@Resource
	private DemandResponseEventDao demandResponseEventDao;

	@Resource
	private VenDemandResponseEventDao venDemandResponseEventDao;

	@Resource
	private DemandResponseEventPublisher demandResponseEventPublisher;

	@Resource
	private Executor executor;

	private static DatatypeFactory datatypeFactory;
	static {
		try {
<span class="fc" id="L64">			datatypeFactory = DatatypeFactory.newInstance();</span>

<span class="nc" id="L66">		} catch (DatatypeConfigurationException e) {</span>
<span class="nc" id="L67">			LOGGER.error(&quot;&quot;, e);</span>
<span class="nc" id="L68">			throw new OadrVTNInitializationException(e);</span>
<span class="fc" id="L69">		}</span>
<span class="fc" id="L70">	}</span>

	public Iterable&lt;DemandResponseEvent&gt; findAll() {
<span class="nc" id="L73">		return demandResponseEventDao.findAll();</span>
	}

	public List&lt;DemandResponseEvent&gt; find(String venUsername, DemandResponseEventStateEnum state) {
<span class="fc" id="L77">		return this.find(venUsername, state, null);</span>
	}

	public List&lt;DemandResponseEvent&gt; find(String venUsername, DemandResponseEventStateEnum state, Long size) {
<span class="fc" id="L81">		Pageable limit = null;</span>
<span class="fc bfc" id="L82" title="All 2 branches covered.">		if (size != null) {</span>
<span class="fc" id="L83">			int i = (int) (long) size;</span>
<span class="fc" id="L84">			limit = new PageRequest(0, i);</span>
		}

<span class="fc" id="L87">		Iterable&lt;DemandResponseEvent&gt; events = new ArrayList&lt;DemandResponseEvent&gt;();</span>

<span class="fc bfc" id="L89" title="All 6 branches covered.">		if (venUsername == null &amp;&amp; state == null &amp;&amp; limit == null) {</span>
<span class="fc" id="L90">			events = demandResponseEventDao.findAll();</span>

<span class="pc bpc" id="L92" title="1 of 6 branches missed.">		} else if (venUsername == null &amp;&amp; state == null &amp;&amp; limit != null) {</span>
<span class="fc" id="L93">			events = demandResponseEventDao.findAll(limit);</span>

<span class="fc bfc" id="L95" title="All 6 branches covered.">		} else if (venUsername != null &amp;&amp; state == null &amp;&amp; limit == null) {</span>
<span class="fc" id="L96">			events = demandResponseEventDao.findByVenUsername(venUsername);</span>

<span class="pc bpc" id="L98" title="1 of 6 branches missed.">		} else if (venUsername != null &amp;&amp; state == null &amp;&amp; limit != null) {</span>
<span class="fc" id="L99">			events = demandResponseEventDao.findByVenUsername(venUsername, limit);</span>

<span class="pc bpc" id="L101" title="1 of 6 branches missed.">		} else if (venUsername == null &amp;&amp; state != null &amp;&amp; limit == null) {</span>
<span class="fc" id="L102">			events = demandResponseEventDao.findByState(state);</span>

<span class="pc bpc" id="L104" title="2 of 6 branches missed.">		} else if (venUsername == null &amp;&amp; state != null &amp;&amp; limit != null) {</span>
<span class="fc" id="L105">			events = demandResponseEventDao.findByState(state, limit);</span>

<span class="pc bpc" id="L107" title="2 of 6 branches missed.">		} else if (venUsername != null &amp;&amp; state != null &amp;&amp; limit == null) {</span>
<span class="fc" id="L108">			events = demandResponseEventDao.findByVenUsernameAndState(venUsername, state);</span>

<span class="pc bpc" id="L110" title="3 of 6 branches missed.">		} else if (venUsername != null &amp;&amp; state != null &amp;&amp; limit != null) {</span>
<span class="fc" id="L111">			events = demandResponseEventDao.findByVenUsernameAndState(venUsername, state, limit);</span>
		}

<span class="fc" id="L114">		return Lists.newArrayList(events);</span>
	}

	/**
	 * create a DR Event
	 * 
	 * @param event
	 * @return
	 */
	@Transactional
	public DemandResponseEvent create(DemandResponseEvent event) {

<span class="fc" id="L126">		event.setCreatedTimestamp(System.currentTimeMillis());</span>
<span class="fc" id="L127">		event.setModificationNumber(0);</span>

<span class="fc" id="L129">		event.setOadrProfile(DemandResponseEventOadrProfileEnum.OADR20A);</span>

<span class="fc" id="L131">		Date dateStart = new Date();</span>
<span class="fc" id="L132">		dateStart.setTime(event.getStart());</span>

		// compute end from start and duration
<span class="fc" id="L135">		Duration duration = datatypeFactory.newDuration(event.getDuration());</span>
<span class="fc" id="L136">		long durationInMillis = duration.getTimeInMillis(dateStart);</span>
<span class="fc" id="L137">		event.setEnd(dateStart.getTime() + durationInMillis);</span>

		// compute startNotification from start and notificationDuration
<span class="fc" id="L140">		Duration notificationDuration = datatypeFactory.newDuration(event.getNotificationDuration());</span>
<span class="fc" id="L141">		long notificationDurationInMillis = notificationDuration.getTimeInMillis(dateStart);</span>
<span class="fc" id="L142">		event.setStartNotification(dateStart.getTime() - notificationDurationInMillis);</span>

<span class="fc" id="L144">		List&lt;String&gt; targetedVenUsername = Arrays.asList(event.getComaSeparatedTargetedVenUsername().split(&quot;,&quot;));</span>

<span class="fc" id="L146">		List&lt;Ven&gt; findByUsernameIn = venDao.findByUsernameInAndVenMarketContextsContains(targetedVenUsername,</span>
<span class="fc" id="L147">				event.getMarketContext());</span>
<span class="fc" id="L148">		List&lt;VenDemandResponseEvent&gt; list = new ArrayList&lt;VenDemandResponseEvent&gt;();</span>
<span class="fc bfc" id="L149" title="All 2 branches covered.">		for (Ven ven : findByUsernameIn) {</span>
<span class="pc bpc" id="L150" title="4 of 6 branches missed.">			if (supportPush &amp;&amp; ven.getPushUrl() != null &amp;&amp; demandResponseEventPublisher != null) {</span>
<span class="nc" id="L151">				demandResponseEventPublisher.publish20a(ven);</span>
			}
<span class="fc" id="L153">			list.add(new VenDemandResponseEvent(event, ven));</span>
<span class="fc" id="L154">		}</span>
<span class="fc" id="L155">		venDemandResponseEventDao.save(list);</span>
<span class="fc" id="L156">		return demandResponseEventDao.save(event);</span>
	}

	/**
	 * create a DR Event
	 * 
	 * @param event
	 * @return
	 */
	@Transactional(readOnly = false)
	private DemandResponseEvent persist(DemandResponseEvent event, List&lt;VenDemandResponseEvent&gt; list) {
<span class="fc" id="L167">		venDemandResponseEventDao.save(list);</span>
<span class="fc" id="L168">		return demandResponseEventDao.save(event);</span>
	}

	private void publish(List&lt;Ven&gt; vens, DemandResponseEventOadrProfileEnum profile) {
<span class="fc" id="L172">		Runnable run = new Runnable() {</span>

			@Override
			public void run() {
				try {
<span class="nc" id="L177">					Thread.sleep(2000);</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">					for (Ven ven : vens) {</span>
						// the receiver check if ven is a push ven and how it
						// does
						// make
						// event available if not
<span class="nc bnc" id="L183" title="All 2 branches missed.">						if (DemandResponseEventOadrProfileEnum.OADR20B.equals(profile)</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">								&amp;&amp; DemandResponseEventOadrProfileEnum.OADR20B.getCode().equals(ven.getOadrProfil())) {</span>
<span class="nc" id="L185">							demandResponseEventPublisher.publish20b(ven);</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">						} else if (DemandResponseEventOadrProfileEnum.OADR20A.equals(profile)) {</span>
<span class="nc" id="L187">							demandResponseEventPublisher.publish20a(ven);</span>
						}
<span class="nc" id="L189">					}</span>
<span class="nc" id="L190">				} catch (InterruptedException e) {</span>
<span class="nc" id="L191">					LOGGER.error(&quot;&quot;, e);</span>
<span class="nc" id="L192">				}</span>
<span class="nc" id="L193">			}</span>

		};

<span class="fc" id="L197">		executor.execute(run);</span>

<span class="fc" id="L199">	}</span>

	private DemandResponseEvent createOrUpdate(DemandResponseEvent event, String eventId, long modificationNumber,
			Long start, String durationXml, String notificationDurationXml, List&lt;String&gt; targetedVenUsername,
			VenMarketContext marketContext, DemandResponseEventStateEnum state, String payload,
			DemandResponseEventOadrProfileEnum profile) {
<span class="fc" id="L205">		event.setEventId(eventId);</span>
<span class="fc" id="L206">		event.setCreatedTimestamp(System.currentTimeMillis());</span>
<span class="fc" id="L207">		event.setModificationNumber(modificationNumber);</span>
<span class="fc" id="L208">		event.setComaSeparatedTargetedVenUsername(String.join(&quot;,&quot;, targetedVenUsername));</span>
<span class="fc" id="L209">		event.setStart(start);</span>
<span class="fc" id="L210">		event.setMarketContext(marketContext);</span>
<span class="fc" id="L211">		event.setDuration(durationXml);</span>
<span class="fc" id="L212">		event.setNotificationDuration(notificationDurationXml);</span>
<span class="fc" id="L213">		event.setState(state);</span>
<span class="fc" id="L214">		event.setEvent(payload);</span>
<span class="fc" id="L215">		Date dateStart = new Date();</span>
<span class="fc" id="L216">		dateStart.setTime(start);</span>
<span class="fc" id="L217">		event.setOadrProfile(profile);</span>
		// compute end from start and duration
<span class="fc" id="L219">		Duration duration = datatypeFactory.newDuration(durationXml);</span>
<span class="fc" id="L220">		long durationInMillis = duration.getTimeInMillis(dateStart);</span>
<span class="fc" id="L221">		event.setEnd(dateStart.getTime() + durationInMillis);</span>

		// compute startNotification from start and notificationDuration
<span class="fc" id="L224">		Duration notificationDuration = datatypeFactory.newDuration(notificationDurationXml);</span>
<span class="fc" id="L225">		long notificationDurationInMillis = notificationDuration.getTimeInMillis(dateStart);</span>
<span class="fc" id="L226">		event.setStartNotification(dateStart.getTime() - notificationDurationInMillis);</span>

<span class="fc" id="L228">		List&lt;Ven&gt; findByUsernameIn = venDao.findByUsernameInAndVenMarketContextsContains(targetedVenUsername,</span>
				marketContext);
<span class="fc" id="L230">		List&lt;VenDemandResponseEvent&gt; list = new ArrayList&lt;VenDemandResponseEvent&gt;();</span>

<span class="fc bfc" id="L232" title="All 2 branches covered.">		for (Ven ven : findByUsernameIn) {</span>
<span class="fc" id="L233">			list.add(new VenDemandResponseEvent(event, ven));</span>
<span class="fc" id="L234">		}</span>

<span class="fc" id="L236">		DemandResponseEvent save = this.persist(event, list);</span>
<span class="fc" id="L237">		this.publish(findByUsernameIn, profile);</span>

<span class="fc" id="L239">		return save;</span>

	}

	public DemandResponseEvent update(DemandResponseEvent event, String eventId, long modificationNumber, Long start,
			String durationXml, String notificationDurationXml, List&lt;String&gt; targetedVenUsername,
			VenMarketContext marketContext, DemandResponseEventStateEnum state, String payload,
			DemandResponseEventOadrProfileEnum profile) {
<span class="nc" id="L247">		venDemandResponseEventDao.deleteByEventId(event.getId());</span>
<span class="nc" id="L248">		return createOrUpdate(event, eventId, modificationNumber, start, durationXml, notificationDurationXml,</span>
				targetedVenUsername, marketContext, state, payload, profile);
	}

	public DemandResponseEvent create(String eventId, Long start, String durationXml, String notificationDurationXml,
			List&lt;String&gt; targetedVenUsername, VenMarketContext marketContext, DemandResponseEventStateEnum state,
			String payload, DemandResponseEventOadrProfileEnum profile) {
<span class="fc" id="L255">		return createOrUpdate(new DemandResponseEvent(), eventId, 0L, start, durationXml, notificationDurationXml,</span>
				targetedVenUsername, marketContext, state, payload, profile);
	}

	public DemandResponseEvent findById(Long id) {
<span class="fc" id="L260">		return demandResponseEventDao.findOne(id);</span>
	}

	public DemandResponseEvent findByEventId(String eventId) {
<span class="nc" id="L264">		return demandResponseEventDao.findOneByEventId(eventId);</span>
	}

	public boolean delete(Long id) {
<span class="fc" id="L268">		boolean exists = demandResponseEventDao.exists(id);</span>
<span class="fc bfc" id="L269" title="All 2 branches covered.">		if (exists) {</span>
<span class="fc" id="L270">			venDemandResponseEventDao.deleteByEventId(id);</span>
<span class="fc" id="L271">			demandResponseEventDao.delete(id);</span>
		}
<span class="fc" id="L273">		return exists;</span>
	}

	public void delete(Iterable&lt;DemandResponseEvent&gt; entities) {
<span class="fc" id="L277">		venDemandResponseEventDao.deleteByEventIn(Lists.newArrayList(entities));</span>
<span class="fc" id="L278">		demandResponseEventDao.delete(entities);</span>
<span class="fc" id="L279">	}</span>

	private DemandResponseEvent updateState(Long id, DemandResponseEventStateEnum state) {
<span class="fc" id="L282">		DemandResponseEvent event = demandResponseEventDao.findOne(id);</span>
<span class="fc bfc" id="L283" title="All 2 branches covered.">		if (event == null) {</span>
<span class="fc" id="L284">			return null;</span>
		}
<span class="fc bfc" id="L286" title="All 2 branches covered.">		if (!event.getState().equals(state)) {</span>
<span class="fc" id="L287">			event.setState(state);</span>
<span class="fc" id="L288">			event.setModificationNumber(event.getModificationNumber() + 1);</span>
<span class="fc" id="L289">			event.setLastUpdateTimestamp(System.currentTimeMillis());</span>
<span class="fc" id="L290">			return demandResponseEventDao.save(event);</span>
		}

<span class="fc" id="L293">		return event;</span>
	}

	public DemandResponseEvent cancel(Long id) {
<span class="fc" id="L297">		return updateState(id, DemandResponseEventStateEnum.CANCELED);</span>
	}

	public DemandResponseEvent active(Long id) {
<span class="fc" id="L301">		return updateState(id, DemandResponseEventStateEnum.ACTIVE);</span>
	}

	public DemandResponseEvent updateValue(Long id, DemandResponseEventSimpleValueEnum value) {
<span class="fc" id="L305">		DemandResponseEvent event = demandResponseEventDao.findOne(id);</span>
<span class="fc bfc" id="L306" title="All 2 branches covered.">		if (event == null) {</span>
<span class="fc" id="L307">			return null;</span>
		}

<span class="fc bfc" id="L310" title="All 2 branches covered.">		if (!value.equals(event.getValue())) {</span>
<span class="fc" id="L311">			event.setValue(value);</span>
<span class="fc" id="L312">			event.setModificationNumber(event.getModificationNumber() + 1);</span>
<span class="fc" id="L313">			event.setLastUpdateTimestamp(System.currentTimeMillis());</span>
<span class="fc" id="L314">			return demandResponseEventDao.save(event);</span>
		}

<span class="fc" id="L317">		return event;</span>
	}

	public List&lt;DemandResponseEvent&gt; findToSentEventByVen(Ven ven) {
<span class="fc" id="L321">		return this.findToSentEventByVen(ven, null);</span>
	}

	public List&lt;DemandResponseEvent&gt; findToSentEventByVen(Ven ven, Long size) {
<span class="fc" id="L325">		long currentTimeMillis = System.currentTimeMillis();</span>

<span class="pc bpc" id="L327" title="1 of 4 branches missed.">		if (size != null &amp;&amp; size &gt; 0) {</span>
<span class="fc" id="L328">			Pageable limit = null;</span>
<span class="fc" id="L329">			int i = (int) (long) size;</span>
<span class="fc" id="L330">			limit = new PageRequest(0, i);</span>
<span class="fc" id="L331">			return demandResponseEventDao.findToSentEventByVen(ven, currentTimeMillis, limit);</span>
		} else {
<span class="fc" id="L333">			return demandResponseEventDao.findToSentEventByVen(ven, currentTimeMillis);</span>
		}
	}

	public boolean hasResponded(String venId, DemandResponseEvent event) {
<span class="fc" id="L338">		VenDemandResponseEvent findOneByEventAndVen = venDemandResponseEventDao.findOneByEventAndVenId(event, venId);</span>
<span class="fc bfc" id="L339" title="All 2 branches covered.">		return findOneByEventAndVen.getVenOpt() != null;</span>
	}

	/**
	 * update ven optin for a specific event
	 * 
	 * @param demandResponseEvent
	 * @param ven
	 * @param venOpt
	 */
	public void updateVenOpt(Long demandResponseEventId, Long modificationNumber, String venUsername,
			DemandResponseEventOptEnum venOpt) {

<span class="fc" id="L352">		VenDemandResponseEvent findOneByEventIdAndVenId = venDemandResponseEventDao</span>
<span class="fc" id="L353">				.findOneByEventIdAndVenUsername(demandResponseEventId, venUsername);</span>

<span class="pc bpc" id="L355" title="1 of 2 branches missed.">		if (findOneByEventIdAndVenId != null) {</span>
<span class="fc" id="L356">			findOneByEventIdAndVenId.setVenOpt(venOpt);</span>
<span class="fc" id="L357">			findOneByEventIdAndVenId.setLastSentModificationNumber(modificationNumber);</span>
<span class="fc" id="L358">			venDemandResponseEventDao.save(findOneByEventIdAndVenId);</span>
		}
<span class="fc" id="L360">	}</span>

	/**
	 * get ven optin for a specific event
	 * 
	 * @param demandResponseEvent
	 * @param ven
	 * @param venOpt
	 */
	public DemandResponseEventOptEnum getVenOpt(Long demandResponseEventId, String venUsername) {

<span class="fc" id="L371">		VenDemandResponseEvent findOneByEventIdAndVenId = venDemandResponseEventDao</span>
<span class="fc" id="L372">				.findOneByEventIdAndVenUsername(demandResponseEventId, venUsername);</span>

<span class="pc bpc" id="L374" title="1 of 2 branches missed.">		if (findOneByEventIdAndVenId != null) {</span>
<span class="fc" id="L375">			return findOneByEventIdAndVenId.getVenOpt();</span>
		}
<span class="nc" id="L377">		return null;</span>
	}

	public List&lt;DemandResponseEvent&gt; findToSentEventByVenUsername(String username) {
<span class="fc" id="L381">		return this.findToSentEventByVenUsername(username, null);</span>
	}

	public List&lt;DemandResponseEvent&gt; findToSentEventByVenUsername(String username, Long size) {
<span class="fc" id="L385">		long currentTimeMillis = System.currentTimeMillis() - 60 * 1000;</span>
<span class="pc bpc" id="L386" title="1 of 4 branches missed.">		if (size != null &amp;&amp; size &gt; 0) {</span>
<span class="fc" id="L387">			Pageable limit = null;</span>
<span class="fc" id="L388">			int i = (int) (long) size;</span>
<span class="fc" id="L389">			limit = new PageRequest(0, i);</span>
<span class="fc" id="L390">			return demandResponseEventDao.findToSentEventByVenUsername(username, currentTimeMillis, limit);</span>
		} else {
<span class="fc" id="L392">			return demandResponseEventDao.findToSentEventByVenUsername(username, currentTimeMillis);</span>
		}
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>