<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>VenController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">OpenADRServerVTNCommon</a> &gt; <a href="index.source.html" class="el_package">com.avob.openadr.server.common.vtn.controller</a> &gt; <span class="el_source">VenController.java</span></div><h1>VenController.java</h1><pre class="source lang-java linenums">package com.avob.openadr.server.common.vtn.controller;

import java.util.Collections;
import java.util.List;

import javax.annotation.Resource;
import javax.servlet.http.HttpServletResponse;
import javax.validation.Valid;

import org.eclipse.jetty.http.HttpStatus;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.RestController;

import com.avob.openadr.server.common.vtn.models.ven.Ven;
import com.avob.openadr.server.common.vtn.models.ven.VenCreateDto;
import com.avob.openadr.server.common.vtn.models.ven.VenUpdateDto;
import com.avob.openadr.server.common.vtn.models.vengroup.VenGroup;
import com.avob.openadr.server.common.vtn.models.vengroup.VenGroupDto;
import com.avob.openadr.server.common.vtn.models.venmarketcontext.VenMarketContext;
import com.avob.openadr.server.common.vtn.models.venmarketcontext.VenMarketContextDto;
import com.avob.openadr.server.common.vtn.models.venresource.VenResource;
import com.avob.openadr.server.common.vtn.models.venresource.VenResourceDto;
import com.avob.openadr.server.common.vtn.service.VenGroupService;
import com.avob.openadr.server.common.vtn.service.VenMarketContextService;
import com.avob.openadr.server.common.vtn.service.VenResourceService;
import com.avob.openadr.server.common.vtn.service.VenService;
import com.avob.openadr.server.common.vtn.service.dtomapper.DtoMapper;

@RestController
@RequestMapping(&quot;/Ven&quot;)
@PreAuthorize(&quot;hasRole('ROLE_ADMIN')&quot;)
<span class="fc" id="L40">public class VenController {</span>

<span class="fc" id="L42">	private static final Logger LOGGER = LoggerFactory.getLogger(VenController.class);</span>

	@Resource
	private VenService venService;

	@Resource
	private VenResourceService venResourceService;

	@Resource
	private VenGroupService venGroupService;

	@Resource
	private VenMarketContextService venMarketContextService;

	@Resource
	private DtoMapper dtoMapper;

	@RequestMapping(value = &quot;/&quot;, method = RequestMethod.GET)
	@ResponseBody
	public List&lt;VenCreateDto&gt; listVen() {
<span class="fc" id="L62">		return dtoMapper.mapList(venService.findAll(), VenCreateDto.class);</span>
	}

	@RequestMapping(value = &quot;/&quot;, method = RequestMethod.POST)
	@ResponseBody
	public VenCreateDto createVen(@Valid @RequestBody VenCreateDto dto, HttpServletResponse response) {

<span class="fc" id="L69">		Ven findOneByUsername = venService.findOneByUsername(dto.getUsername());</span>

<span class="fc bfc" id="L71" title="All 2 branches covered.">		if (findOneByUsername != null) {</span>
<span class="fc" id="L72">			LOGGER.warn(&quot;Ven: &quot; + dto.getUsername() + &quot; already exists&quot;);</span>
<span class="fc" id="L73">			response.setStatus(HttpStatus.NOT_ACCEPTABLE_406);</span>
<span class="fc" id="L74">			return null;</span>
		}
<span class="fc" id="L76">		Ven prepare = venService.prepare(dto);</span>
<span class="fc" id="L77">		venService.save(prepare);</span>
<span class="fc" id="L78">		response.setStatus(HttpStatus.CREATED_201);</span>
<span class="fc" id="L79">		LOGGER.info(&quot;Create Ven: &quot; + prepare.getUsername());</span>
<span class="fc" id="L80">		return dtoMapper.map(prepare, VenCreateDto.class);</span>
	}

	@RequestMapping(value = &quot;/{venID}&quot;, method = RequestMethod.PUT)
	@ResponseBody
	public VenCreateDto updateVen(@PathVariable(&quot;venID&quot;) String venUsername, @Valid @RequestBody VenUpdateDto dto,
			HttpServletResponse response) {

<span class="nc" id="L88">		Ven ven = venService.findOneByUsername(venUsername);</span>

<span class="nc bnc" id="L90" title="All 2 branches missed.">		if (ven == null) {</span>
<span class="nc" id="L91">			LOGGER.warn(&quot;Unknown Ven: &quot; + venUsername);</span>
<span class="nc" id="L92">			response.setStatus(HttpStatus.NOT_FOUND_404);</span>
<span class="nc" id="L93">			return null;</span>
		}
<span class="nc bnc" id="L95" title="All 2 branches missed.">		if (dto.getName() != null) {</span>
<span class="nc" id="L96">			ven.setName(dto.getName());</span>
		}
<span class="nc bnc" id="L98" title="All 2 branches missed.">		if (dto.getPullFrequencySeconds() != null) {</span>
<span class="nc" id="L99">			ven.setPullFrequencySeconds(dto.getPullFrequencySeconds());</span>
		}
<span class="nc" id="L101">		venService.save(ven);</span>
<span class="nc" id="L102">		response.setStatus(HttpStatus.CREATED_201);</span>
<span class="nc" id="L103">		LOGGER.info(&quot;Update Ven: &quot; + ven.getUsername());</span>
<span class="nc" id="L104">		return dtoMapper.map(ven, VenCreateDto.class);</span>
	}

	@RequestMapping(value = &quot;/{venID}&quot;, method = RequestMethod.GET)
	@ResponseBody
	public VenCreateDto findVenByUsername(@PathVariable(&quot;venID&quot;) String venUsername, HttpServletResponse response) {
<span class="fc" id="L110">		Ven ven = venService.findOneByUsername(venUsername);</span>
<span class="fc bfc" id="L111" title="All 2 branches covered.">		if (ven == null) {</span>
<span class="fc" id="L112">			LOGGER.warn(&quot;Unknown Ven: &quot; + venUsername);</span>
<span class="fc" id="L113">			response.setStatus(HttpStatus.NOT_FOUND_404);</span>
<span class="fc" id="L114">			return null;</span>
		}
<span class="fc" id="L116">		return dtoMapper.map(ven, VenCreateDto.class);</span>
	}

	@RequestMapping(value = &quot;/{venID}&quot;, method = RequestMethod.DELETE)
	@ResponseBody
	public void deleteVenByUsername(@PathVariable(&quot;venID&quot;) String venUsername, HttpServletResponse response) {
<span class="fc" id="L122">		Ven ven = venService.findOneByUsername(venUsername);</span>
<span class="pc bpc" id="L123" title="1 of 2 branches missed.">		if (ven == null) {</span>
<span class="nc" id="L124">			LOGGER.warn(&quot;Unknown Ven: &quot; + venUsername);</span>
<span class="nc" id="L125">			response.setStatus(HttpStatus.NOT_FOUND_404);</span>
<span class="nc" id="L126">			return;</span>
		}
<span class="fc" id="L128">		venService.delete(ven);</span>
<span class="fc" id="L129">		LOGGER.info(&quot;Delete Ven: &quot; + ven.getUsername());</span>
<span class="fc" id="L130">	}</span>

	@RequestMapping(value = &quot;/{venID}/resource&quot;, method = RequestMethod.POST)
	@ResponseBody
	public VenResourceDto createVenResource(@PathVariable(&quot;venID&quot;) String venUsername, @RequestBody VenResourceDto dto,
			HttpServletResponse response) {
<span class="fc" id="L136">		Ven ven = venService.findOneByUsername(venUsername);</span>
<span class="fc bfc" id="L137" title="All 2 branches covered.">		if (ven == null) {</span>
<span class="fc" id="L138">			LOGGER.warn(&quot;Unknown Ven: &quot; + venUsername);</span>
<span class="fc" id="L139">			response.setStatus(HttpStatus.NOT_FOUND_404);</span>
<span class="fc" id="L140">			return null;</span>
		}
<span class="fc" id="L142">		VenResource findByVenAndName = venResourceService.findByVenAndName(ven, dto.getName());</span>
<span class="fc bfc" id="L143" title="All 2 branches covered.">		if (findByVenAndName != null) {</span>
<span class="fc" id="L144">			LOGGER.warn(&quot;Resource: &quot; + dto.getName() + &quot; already exists for Ven: &quot; + venUsername);</span>
<span class="fc" id="L145">			response.setStatus(HttpStatus.NOT_ACCEPTABLE_406);</span>
<span class="fc" id="L146">			return null;</span>
		}

<span class="fc" id="L149">		VenResource prepare = venResourceService.prepare(ven, dto);</span>
<span class="fc" id="L150">		venResourceService.save(prepare);</span>
<span class="fc" id="L151">		response.setStatus(HttpStatus.CREATED_201);</span>
<span class="fc" id="L152">		LOGGER.info(&quot;Create Resource: &quot; + dto.getName() + &quot; linked to Ven: &quot; + ven.getUsername());</span>
<span class="fc" id="L153">		return dtoMapper.map(prepare, VenResourceDto.class);</span>
	}

	@RequestMapping(value = &quot;/{venID}/resource&quot;, method = RequestMethod.GET)
	@ResponseBody
	public List&lt;VenResourceDto&gt; listVenResource(@PathVariable(&quot;venID&quot;) String venUsername,
			HttpServletResponse response) {
<span class="fc" id="L160">		Ven ven = venService.findOneByUsername(venUsername);</span>
<span class="fc bfc" id="L161" title="All 2 branches covered.">		if (ven == null) {</span>
<span class="fc" id="L162">			LOGGER.warn(&quot;Unknown Ven: &quot; + venUsername);</span>
<span class="fc" id="L163">			response.setStatus(HttpStatus.NOT_FOUND_404);</span>
<span class="fc" id="L164">			return Collections.emptyList();</span>
		}
<span class="fc" id="L166">		return dtoMapper.mapList(venResourceService.findByVen(ven), VenResourceDto.class);</span>
	}

	@RequestMapping(value = &quot;/{venID}/resource/{resourceName}&quot;, method = RequestMethod.DELETE)
	@ResponseBody
	public void deleteVenResource(@PathVariable(&quot;venID&quot;) String venUsername,
			@PathVariable(&quot;resourceName&quot;) String resourceName, HttpServletResponse response) {
<span class="fc" id="L173">		Ven ven = venService.findOneByUsername(venUsername);</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">		if (ven == null) {</span>
<span class="fc" id="L175">			LOGGER.warn(&quot;Unknown Ven: &quot; + venUsername);</span>
<span class="fc" id="L176">			response.setStatus(HttpStatus.NOT_FOUND_404);</span>
<span class="fc" id="L177">			return;</span>
		}
<span class="fc" id="L179">		VenResource findByVenAndName = venResourceService.findByVenAndName(ven, resourceName);</span>
<span class="fc bfc" id="L180" title="All 2 branches covered.">		if (findByVenAndName == null) {</span>
<span class="fc" id="L181">			LOGGER.warn(&quot;Unknown Resource: &quot; + resourceName + &quot; for Ven: &quot; + venUsername);</span>
<span class="fc" id="L182">			response.setStatus(HttpStatus.NOT_FOUND_404);</span>
<span class="fc" id="L183">			return;</span>
		}
<span class="fc" id="L185">		venResourceService.delete(findByVenAndName);</span>
<span class="fc" id="L186">		LOGGER.info(&quot;Delete Resource: &quot; + resourceName + &quot; from Ven: &quot; + ven.getUsername());</span>
<span class="fc" id="L187">	}</span>

	@RequestMapping(value = &quot;/{venID}/group&quot;, method = RequestMethod.POST)
	@ResponseBody
	public VenCreateDto addGroupToVen(@PathVariable(&quot;venID&quot;) String venUsername,
			@RequestParam(&quot;group&quot;) String groupName, HttpServletResponse response) {
<span class="fc" id="L193">		Ven ven = venService.findOneByUsername(venUsername);</span>
<span class="fc bfc" id="L194" title="All 2 branches covered.">		if (ven == null) {</span>
<span class="fc" id="L195">			LOGGER.warn(&quot;Unknown Ven: &quot; + venUsername);</span>
<span class="fc" id="L196">			response.setStatus(HttpStatus.NOT_FOUND_404);</span>
<span class="fc" id="L197">			return null;</span>
		}
<span class="fc" id="L199">		VenGroup findByName = venGroupService.findByName(groupName);</span>
<span class="fc bfc" id="L200" title="All 2 branches covered.">		if (findByName == null) {</span>
<span class="fc" id="L201">			LOGGER.warn(&quot;Unknown Group: &quot; + groupName);</span>
<span class="fc" id="L202">			response.setStatus(HttpStatus.NOT_FOUND_404);</span>
<span class="fc" id="L203">			return null;</span>
		}
<span class="fc" id="L205">		ven.getVenGroups().add(findByName);</span>
<span class="fc" id="L206">		venService.save(ven);</span>
<span class="fc" id="L207">		response.setStatus(HttpStatus.OK_200);</span>
<span class="fc" id="L208">		LOGGER.info(&quot;Add Group: &quot; + groupName + &quot; to Ven: &quot; + ven.getUsername());</span>
<span class="fc" id="L209">		return dtoMapper.map(ven, VenCreateDto.class);</span>
	}

	@RequestMapping(value = &quot;/{venID}/group&quot;, method = RequestMethod.GET)
	@ResponseBody
	public List&lt;VenGroupDto&gt; listVenGroup(@PathVariable(&quot;venID&quot;) String venUsername, HttpServletResponse response) {
<span class="fc" id="L215">		Ven ven = venService.findOneByUsername(venUsername);</span>
<span class="fc bfc" id="L216" title="All 2 branches covered.">		if (ven == null) {</span>
<span class="fc" id="L217">			LOGGER.warn(&quot;Unknown Ven: &quot; + venUsername);</span>
<span class="fc" id="L218">			response.setStatus(HttpStatus.NOT_FOUND_404);</span>
<span class="fc" id="L219">			return Collections.emptyList();</span>
		}
<span class="fc" id="L221">		return dtoMapper.mapList(ven.getVenGroups(), VenGroupDto.class);</span>
	}

	@RequestMapping(value = &quot;/{venID}/group/remove&quot;, method = RequestMethod.POST)
	@ResponseBody
	public void deleteVenGroup(@PathVariable(&quot;venID&quot;) String venUsername, @RequestParam(&quot;group&quot;) String groupName,
			HttpServletResponse response) {
<span class="fc" id="L228">		Ven ven = venService.findOneByUsername(venUsername);</span>
<span class="fc bfc" id="L229" title="All 2 branches covered.">		if (ven == null) {</span>
<span class="fc" id="L230">			LOGGER.warn(&quot;Unknown Ven: &quot; + venUsername);</span>
<span class="fc" id="L231">			response.setStatus(HttpStatus.NOT_FOUND_404);</span>
<span class="fc" id="L232">			return;</span>
		}
<span class="fc" id="L234">		VenGroup findByName = venGroupService.findByName(groupName);</span>
<span class="fc bfc" id="L235" title="All 2 branches covered.">		if (findByName == null) {</span>
<span class="fc" id="L236">			LOGGER.warn(&quot;Unknown Group: &quot; + groupName);</span>
<span class="fc" id="L237">			response.setStatus(HttpStatus.NOT_FOUND_404);</span>
<span class="fc" id="L238">			return;</span>
		}
<span class="fc" id="L240">		ven.getVenGroups().remove(findByName);</span>
<span class="fc" id="L241">		venService.save(ven);</span>
<span class="fc" id="L242">		LOGGER.info(&quot;Remove Group: &quot; + groupName + &quot; from Ven: &quot; + ven.getUsername());</span>
<span class="fc" id="L243">		response.setStatus(HttpStatus.OK_200);</span>
<span class="fc" id="L244">	}</span>

	@RequestMapping(value = &quot;/{venID}/marketContext&quot;, method = RequestMethod.POST)
	@ResponseBody
	public VenCreateDto addMarketContextToVen(@PathVariable(&quot;venID&quot;) String venUsername,
			@RequestParam(&quot;marketContext&quot;) String marketContextName, HttpServletResponse response) {
<span class="fc" id="L250">		Ven ven = venService.findOneByUsername(venUsername);</span>
<span class="fc bfc" id="L251" title="All 2 branches covered.">		if (ven == null) {</span>
<span class="fc" id="L252">			LOGGER.warn(&quot;Unknown Ven: &quot; + venUsername);</span>
<span class="fc" id="L253">			response.setStatus(HttpStatus.NOT_FOUND_404);</span>
<span class="fc" id="L254">			return null;</span>
		}
<span class="fc" id="L256">		VenMarketContext marketContext = venMarketContextService.findOneByName(marketContextName);</span>
<span class="fc bfc" id="L257" title="All 2 branches covered.">		if (marketContext == null) {</span>
<span class="fc" id="L258">			LOGGER.warn(&quot;Unknown MarketContext: &quot; + marketContextName);</span>
<span class="fc" id="L259">			response.setStatus(HttpStatus.NOT_FOUND_404);</span>
<span class="fc" id="L260">			return null;</span>
		}
<span class="fc" id="L262">		ven.getVenMarketContexts().add(marketContext);</span>
<span class="fc" id="L263">		venService.save(ven);</span>
<span class="fc" id="L264">		response.setStatus(HttpStatus.OK_200);</span>
<span class="fc" id="L265">		LOGGER.info(&quot;Add MarketContext: &quot; + marketContextName + &quot; to Ven: &quot; + ven.getUsername());</span>
<span class="fc" id="L266">		return dtoMapper.map(ven, VenCreateDto.class);</span>
	}

	@RequestMapping(value = &quot;/{venID}/marketContext&quot;, method = RequestMethod.GET)
	@ResponseBody
	public List&lt;VenMarketContextDto&gt; listVenMarketContext(@PathVariable(&quot;venID&quot;) String venUsername,
			HttpServletResponse response) {
<span class="fc" id="L273">		Ven ven = venService.findOneByUsername(venUsername);</span>
<span class="fc bfc" id="L274" title="All 2 branches covered.">		if (ven == null) {</span>
<span class="fc" id="L275">			LOGGER.warn(&quot;Unknown Ven: &quot; + venUsername);</span>
<span class="fc" id="L276">			response.setStatus(HttpStatus.NOT_FOUND_404);</span>
<span class="fc" id="L277">			return Collections.emptyList();</span>
		}
<span class="fc" id="L279">		return dtoMapper.mapList(ven.getVenMarketContexts(), VenMarketContextDto.class);</span>
	}

	@RequestMapping(value = &quot;/{venID}/marketContext/remove&quot;, method = RequestMethod.POST)
	@ResponseBody
	public void deleteVenMarketContext(@PathVariable(&quot;venID&quot;) String venUsername,
			@RequestParam(&quot;marketContext&quot;) String marketContextName, HttpServletResponse response) {
<span class="fc" id="L286">		Ven ven = venService.findOneByUsername(venUsername);</span>
<span class="fc bfc" id="L287" title="All 2 branches covered.">		if (ven == null) {</span>
<span class="fc" id="L288">			LOGGER.warn(&quot;Unknown Ven: &quot; + venUsername);</span>
<span class="fc" id="L289">			response.setStatus(HttpStatus.NOT_FOUND_404);</span>
<span class="fc" id="L290">			return;</span>
		}
<span class="fc" id="L292">		VenMarketContext marketContext = venMarketContextService.findOneByName(marketContextName);</span>
<span class="fc bfc" id="L293" title="All 2 branches covered.">		if (marketContext == null) {</span>
<span class="fc" id="L294">			LOGGER.warn(&quot;Unknown MarketContext: &quot; + marketContextName);</span>
<span class="fc" id="L295">			response.setStatus(HttpStatus.NOT_FOUND_404);</span>
<span class="fc" id="L296">			return;</span>
		}
<span class="fc" id="L298">		ven.getVenMarketContexts().remove(marketContext);</span>
<span class="fc" id="L299">		venService.save(ven);</span>
<span class="fc" id="L300">		response.setStatus(HttpStatus.OK_200);</span>
<span class="fc" id="L301">		LOGGER.info(&quot;Remove MarketContext: &quot; + marketContextName + &quot; from Ven: &quot; + ven.getUsername());</span>
<span class="fc" id="L302">	}</span>

	@RequestMapping(value = &quot;/{venID}/cleanRegistration&quot;, method = RequestMethod.POST)
	@ResponseBody
	public void cleanRegistration(@PathVariable(&quot;venID&quot;) String venUsername, HttpServletResponse response) {
<span class="nc" id="L307">		Ven ven = venService.findOneByUsername(venUsername);</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">		if (ven == null) {</span>
<span class="nc" id="L309">			LOGGER.warn(&quot;Unknown Ven: &quot; + venUsername);</span>
<span class="nc" id="L310">			response.setStatus(HttpStatus.NOT_FOUND_404);</span>
<span class="nc" id="L311">			return;</span>
		}

<span class="nc" id="L314">		Ven newVen = new Ven();</span>
<span class="nc" id="L315">		newVen.setId(ven.getId());</span>
<span class="nc" id="L316">		newVen.setUsername(ven.getUsername());</span>
<span class="nc" id="L317">		newVen.setBasicPassword(ven.getBasicPassword());</span>
<span class="nc" id="L318">		newVen.setDigestPassword(ven.getDigestPassword());</span>
<span class="nc" id="L319">		newVen.setName(ven.getName());</span>
<span class="nc" id="L320">		venService.save(newVen);</span>
<span class="nc" id="L321">		response.setStatus(HttpStatus.OK_200);</span>
<span class="nc" id="L322">		LOGGER.info(&quot;Clean registration of Ven: &quot; + ven.getUsername());</span>
<span class="nc" id="L323">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>