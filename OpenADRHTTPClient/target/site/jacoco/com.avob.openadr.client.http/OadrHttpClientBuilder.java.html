<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OadrHttpClientBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">OpenADRHTTPClient</a> &gt; <a href="index.source.html" class="el_package">com.avob.openadr.client.http</a> &gt; <span class="el_source">OadrHttpClientBuilder.java</span></div><h1>OadrHttpClientBuilder.java</h1><pre class="source lang-java linenums">package com.avob.openadr.client.http;

import java.net.URI;
import java.net.URISyntaxException;
import java.util.ArrayList;
import java.util.List;

import org.apache.http.Header;
import org.apache.http.HttpHost;
import org.apache.http.auth.AuthScope;
import org.apache.http.auth.UsernamePasswordCredentials;
import org.apache.http.client.AuthCache;
import org.apache.http.client.CredentialsProvider;
import org.apache.http.client.config.RequestConfig;
import org.apache.http.client.protocol.HttpClientContext;
import org.apache.http.config.Registry;
import org.apache.http.config.RegistryBuilder;
import org.apache.http.conn.HttpClientConnectionManager;
import org.apache.http.conn.socket.ConnectionSocketFactory;
import org.apache.http.conn.socket.PlainConnectionSocketFactory;
import org.apache.http.conn.ssl.SSLConnectionSocketFactory;
import org.apache.http.impl.auth.BasicScheme;
import org.apache.http.impl.auth.DigestScheme;
import org.apache.http.impl.client.BasicAuthCache;
import org.apache.http.impl.client.BasicCredentialsProvider;
import org.apache.http.impl.client.HttpClientBuilder;
import org.apache.http.impl.conn.BasicHttpClientConnectionManager;
import org.apache.http.impl.conn.PoolingHttpClientConnectionManager;
import org.apache.http.message.BasicHeader;

import com.avob.openadr.security.exception.OadrSecurityException;

public class OadrHttpClientBuilder {

    private HttpClientBuilder create;

    /**
     * protocol config
     */
    private String[] protocols;
    private String[] ciphers;

    /**
     * SSL trusted certificate
     */
    private List&lt;String&gt; trustedCertificateFilePath;

    /**
     * default x509 client certificate
     */
    private String clientPrivateKeyPemFilePath;
    private String clientCertificatePemFilePath;

    /**
     * default Digest/Basic authentication
     */
    private CredentialsProvider credsProvider;
<span class="fc" id="L58">    private HttpClientContext localContext = HttpClientContext.create();</span>

    /**
     * polling client
     */
    private Integer totalConnection;
    private Integer totalPerRouteConnection;

    /**
     * timeout
     */
<span class="fc" id="L69">    private RequestConfig.Builder requestConfigBuilder = RequestConfig.custom();</span>

    /**
     * default host
     */
    private URI defaultUri;

    /**
     * default http headers
     */
<span class="fc" id="L79">    private List&lt;Header&gt; headers = new ArrayList&lt;Header&gt;();</span>

    /**
     * enable http
     */
<span class="fc" id="L84">    private boolean enableHttp = false;</span>

<span class="fc" id="L86">    public OadrHttpClientBuilder() {</span>
<span class="fc" id="L87">        create = HttpClientBuilder.create();</span>
<span class="fc" id="L88">    }</span>

    public OadrHttpClientBuilder withTrustedCertificate(List&lt;String&gt; trustedCertificateFilePath) {
<span class="fc" id="L91">        this.trustedCertificateFilePath = trustedCertificateFilePath;</span>
<span class="fc" id="L92">        return this;</span>
    }

    public OadrHttpClientBuilder withProtocol(String[] protocols, String[] ciphers) {
<span class="fc" id="L96">        this.protocols = protocols;</span>
<span class="fc" id="L97">        this.ciphers = ciphers;</span>
<span class="fc" id="L98">        return this;</span>
    }

    public OadrHttpClientBuilder withX509Authentication(String clientPrivateKeyPemFilePath,
            String clientCertificatePemFilePath) throws OadrSecurityException {
<span class="fc" id="L103">        this.clientPrivateKeyPemFilePath = clientPrivateKeyPemFilePath;</span>
<span class="fc" id="L104">        this.clientCertificatePemFilePath = clientCertificatePemFilePath;</span>
<span class="fc" id="L105">        return this;</span>
    }

    public OadrHttpClientBuilder withDefaultDigestAuthentication(String host, String realm, String nonce,
            String username, String password) throws OadrSecurityException {

<span class="fc" id="L111">        this.withDefaultHost(host);</span>

<span class="fc" id="L113">        HttpHost target = new HttpHost(defaultUri.getHost(), defaultUri.getPort(), defaultUri.getScheme());</span>

<span class="fc" id="L115">        credsProvider = new BasicCredentialsProvider();</span>
<span class="fc" id="L116">        credsProvider.setCredentials(new AuthScope(target.getHostName(), target.getPort()),</span>
                new UsernamePasswordCredentials(username, password));

        // Create AuthCache instance
<span class="fc" id="L120">        AuthCache authCache = new BasicAuthCache();</span>
        // Generate DIGEST scheme object, initialize it and add it to the local
        // auth cache
<span class="fc" id="L123">        DigestScheme digestAuth = new DigestScheme();</span>
        // Suppose we already know the realm name
<span class="fc" id="L125">        digestAuth.overrideParamter(&quot;realm&quot;, realm);</span>
        // Suppose we already know the expected nonce value
<span class="fc" id="L127">        digestAuth.overrideParamter(&quot;nonce&quot;, nonce);</span>
<span class="fc" id="L128">        authCache.put(target, digestAuth);</span>

<span class="fc" id="L130">        localContext.setAuthCache(authCache);</span>

<span class="fc" id="L132">        return this;</span>
    }

    public OadrHttpClientBuilder withDefaultBasicAuthentication(String host, String username, String password)
            throws OadrSecurityException {

<span class="fc" id="L138">        this.withDefaultHost(host);</span>
<span class="fc" id="L139">        HttpHost target = new HttpHost(defaultUri.getHost(), defaultUri.getPort(), defaultUri.getScheme());</span>

<span class="fc" id="L141">        credsProvider = new BasicCredentialsProvider();</span>
<span class="fc" id="L142">        credsProvider.setCredentials(new AuthScope(target.getHostName(), target.getPort()),</span>
                new UsernamePasswordCredentials(username, password));

        // Create AuthCache instance
<span class="fc" id="L146">        AuthCache authCache = new BasicAuthCache();</span>
<span class="fc" id="L147">        BasicScheme basicAuth = new BasicScheme();</span>
<span class="fc" id="L148">        authCache.put(target, basicAuth);</span>

<span class="fc" id="L150">        localContext.setAuthCache(authCache);</span>

<span class="fc" id="L152">        return this;</span>
    }

    /**
     * setup default header
     * 
     * @param header
     * @param value
     * @return
     */
    public OadrHttpClientBuilder withHeader(String header, String value) {
<span class="nc" id="L163">        headers.add(new BasicHeader(header, value));</span>
<span class="nc" id="L164">        return this;</span>
    }

    /**
     * set default host
     * 
     * @param host
     * @return
     * @throws URISyntaxException
     */
    public OadrHttpClientBuilder withDefaultHost(String defaultHost) throws OadrSecurityException {
        try {
<span class="fc" id="L176">            defaultUri = new URI(defaultHost);</span>

<span class="pc bpc" id="L178" title="1 of 2 branches missed.">            if (defaultUri.getHost() == null) {</span>
<span class="nc" id="L179">                throw new OadrSecurityException(&quot;given url must specify target host&quot;);</span>
            }
<span class="nc" id="L181">        } catch (URISyntaxException e) {</span>
<span class="nc" id="L182">            throw new OadrSecurityException(e);</span>
<span class="fc" id="L183">        }</span>
<span class="fc" id="L184">        return this;</span>
    }

    /**
     * setup PoolingHttpClientConnectionManager
     * 
     * @param totalConnection
     * @param totalPerRouteConnection
     * @return
     */
    public OadrHttpClientBuilder withPooling(int totalConnection, int totalPerRouteConnection) {
<span class="fc" id="L195">        this.totalConnection = totalConnection;</span>
<span class="fc" id="L196">        this.totalPerRouteConnection = totalPerRouteConnection;</span>
<span class="fc" id="L197">        return this;</span>
    }

    public OadrHttpClientBuilder withTimeout(int timeoutMilli) {
<span class="fc" id="L201">        requestConfigBuilder.setConnectTimeout(timeoutMilli);</span>
<span class="fc" id="L202">        return this;</span>
    }

    public OadrHttpClientBuilder enableHttp(boolean enable) {
<span class="nc" id="L206">        this.enableHttp = enable;</span>
<span class="nc" id="L207">        return this;</span>
    }

    public OadrHttpClient build() throws OadrSecurityException {

<span class="fc" id="L212">        SSLConnectionSocketFactory createSSLSocketFactory = SSLSocketFactoryBuilder.createSSLSocketFactory(</span>
                clientPrivateKeyPemFilePath, clientCertificatePemFilePath, trustedCertificateFilePath, protocols,
                ciphers);

<span class="fc" id="L216">        RegistryBuilder&lt;ConnectionSocketFactory&gt; register = RegistryBuilder.&lt;ConnectionSocketFactory&gt;create()</span>
<span class="fc" id="L217">                .register(&quot;https&quot;, createSSLSocketFactory);</span>

<span class="pc bpc" id="L219" title="1 of 2 branches missed.">        if (this.enableHttp) {</span>
<span class="nc" id="L220">            register.register(&quot;http&quot;, PlainConnectionSocketFactory.getSocketFactory());</span>
        }

<span class="fc" id="L223">        Registry&lt;ConnectionSocketFactory&gt; build = register.build();</span>

        HttpClientConnectionManager connectionManager;
<span class="pc bpc" id="L226" title="2 of 4 branches missed.">        if (totalConnection != null &amp;&amp; totalPerRouteConnection != null) {</span>
<span class="fc" id="L227">            connectionManager = new PoolingHttpClientConnectionManager(build);</span>
<span class="fc" id="L228">            ((PoolingHttpClientConnectionManager) connectionManager).setMaxTotal(totalConnection);</span>
<span class="fc" id="L229">            ((PoolingHttpClientConnectionManager) connectionManager).setDefaultMaxPerRoute(totalPerRouteConnection);</span>
        } else {
<span class="nc" id="L231">            connectionManager = new BasicHttpClientConnectionManager(build);</span>
        }

<span class="fc" id="L234">        HttpClientBuilder builder = create.setConnectionManager(connectionManager)</span>
<span class="fc" id="L235">                .setDefaultRequestConfig(requestConfigBuilder.build());</span>

<span class="fc bfc" id="L237" title="All 2 branches covered.">        if (credsProvider != null) {</span>
<span class="fc" id="L238">            builder.setDefaultCredentialsProvider(credsProvider);</span>
        }

<span class="fc" id="L241">        return new OadrHttpClient(builder.setDefaultHeaders(headers).build(), defaultUri, localContext);</span>

    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>