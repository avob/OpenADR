<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OadrHttpClient20b.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">OpenADRHTTPClient20b</a> &gt; <a href="index.source.html" class="el_package">com.avob.openadr.client.http.oadr20b</a> &gt; <span class="el_source">OadrHttpClient20b.java</span></div><h1>OadrHttpClient20b.java</h1><pre class="source lang-java linenums">package com.avob.openadr.client.http.oadr20b;

import java.io.IOException;
import java.net.URISyntaxException;
import java.security.PrivateKey;
import java.security.cert.X509Certificate;
import java.util.UUID;

import javax.xml.bind.JAXBElement;
import javax.xml.bind.JAXBException;

import org.apache.http.HttpResponse;
import org.apache.http.HttpStatus;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.client.protocol.HttpClientContext;
import org.apache.http.entity.StringEntity;
import org.apache.http.util.EntityUtils;

import com.avob.openadr.client.http.OadrHttpClient;
import com.avob.openadr.model.oadr20b.Oadr20bFactory;
import com.avob.openadr.model.oadr20b.Oadr20bJAXBContext;
import com.avob.openadr.model.oadr20b.Oadr20bUrlPath;
import com.avob.openadr.model.oadr20b.exception.Oadr20bApplicationLayerException;
import com.avob.openadr.model.oadr20b.exception.Oadr20bException;
import com.avob.openadr.model.oadr20b.exception.Oadr20bHttpLayerException;
import com.avob.openadr.model.oadr20b.exception.Oadr20bMarshalException;
import com.avob.openadr.model.oadr20b.exception.Oadr20bUnmarshalException;
import com.avob.openadr.model.oadr20b.exception.Oadr20bXMLSignatureException;
import com.avob.openadr.model.oadr20b.exception.Oadr20bXMLSignatureValidationException;
import com.avob.openadr.model.oadr20b.oadr.OadrPayload;
import com.avob.openadr.model.oadr20b.xmlsignature.OadrXMLSignatureHandler;
import com.avob.openadr.security.OadrHttpSecurity;
import com.avob.openadr.security.exception.OadrSecurityException;

public class OadrHttpClient20b {

	private OadrHttpClient client;

	/**
	 * xml signature
	 */
	private Long replayProtectAcceptedDelaySecond;
	private PrivateKey privateKey;
	private X509Certificate clientCertificate;

	private Oadr20bJAXBContext jaxbContext;

<span class="pc" id="L49">	private boolean validateXmlPayload = false;</span>

<span class="fc" id="L51">	public OadrHttpClient20b(OadrHttpClient client) throws JAXBException {</span>
<span class="fc" id="L52">		this.jaxbContext = Oadr20bJAXBContext.getInstance();</span>
<span class="fc" id="L53">		this.client = client;</span>
<span class="fc" id="L54">	}</span>

<span class="fc" id="L56">	public OadrHttpClient20b(OadrHttpClient client, boolean validateXmlPayload) throws JAXBException {</span>
<span class="fc" id="L57">		this.jaxbContext = Oadr20bJAXBContext.getInstance();</span>
<span class="fc" id="L58">		this.client = client;</span>
<span class="fc" id="L59">		this.validateXmlPayload = validateXmlPayload;</span>
<span class="fc" id="L60">	}</span>

	public OadrHttpClient20b(OadrHttpClient client, String privateKeyPath, String clientCertificatePath,
<span class="nc" id="L63">			Long replayProtectAcceptedDelaySecond) throws JAXBException, OadrSecurityException {</span>
<span class="nc" id="L64">		this.jaxbContext = Oadr20bJAXBContext.getInstance();</span>
<span class="nc" id="L65">		this.client = client;</span>

<span class="nc" id="L67">		this.privateKey = OadrHttpSecurity.parsePrivateKey(privateKeyPath);</span>
<span class="nc" id="L68">		this.clientCertificate = OadrHttpSecurity.parseCertificate(clientCertificatePath);</span>

<span class="nc" id="L70">		this.replayProtectAcceptedDelaySecond = replayProtectAcceptedDelaySecond;</span>
<span class="nc" id="L71">	}</span>

	private boolean isXmlSignatureEnabled() {
<span class="pc bpc" id="L74" title="5 of 6 branches missed.">		return this.privateKey != null &amp;&amp; this.clientCertificate != null</span>
				&amp;&amp; this.replayProtectAcceptedDelaySecond != null;
	}

	/**
	 * Generic oadr 2.0b using default host/credentials
	 * 
	 * @param payload
	 * @param responseKlass
	 * @return
	 * @throws Oadr20bXMLSignatureValidationException
	 * @throws Oadr20bXMLSignatureException
	 * @throws Oadr20aException
	 * @throws URISyntaxException
	 */
	public &lt;T, I extends JAXBElement&lt;?&gt;&gt; T post(I payload, String path, Class&lt;T&gt; responseKlass) throws Oadr20bException,
			Oadr20bHttpLayerException, Oadr20bXMLSignatureException, Oadr20bXMLSignatureValidationException {
<span class="fc" id="L91">		return this.post(null, path, null, payload, responseKlass);</span>
	}

	private String sign(Object object) throws Oadr20bXMLSignatureException {
<span class="nc" id="L95">		String nonce = UUID.randomUUID().toString();</span>
<span class="nc" id="L96">		Long createdtimestamp = System.currentTimeMillis();</span>
<span class="nc" id="L97">		return OadrXMLSignatureHandler.sign(object, this.privateKey, this.clientCertificate, nonce, createdtimestamp);</span>
	}

	private void validate(OadrPayload payload) throws Oadr20bXMLSignatureValidationException {
<span class="nc" id="L101">		long nowDate = System.currentTimeMillis();</span>
<span class="nc" id="L102">		OadrXMLSignatureHandler.validate(payload, nowDate, replayProtectAcceptedDelaySecond * 1000L);</span>
<span class="nc" id="L103">	}</span>

	/**
	 * Generic oadr 2.0b using given host/credentials
	 * 
	 * @param payload
	 * @param responseKlass
	 * @return
	 * @throws Oadr20bHttpLayerException
	 * @throws Oadr20bXMLSignatureException
	 * @throws Oadr20bXMLSignatureValidationException
	 * @throws Oadr20aException
	 * @throws URISyntaxException
	 */
	public &lt;O, I extends JAXBElement&lt;?&gt;&gt; O post(String host, String path, HttpClientContext context, I payload,
			Class&lt;O&gt; responseKlass) throws Oadr20bException, Oadr20bHttpLayerException, Oadr20bXMLSignatureException,
			Oadr20bXMLSignatureValidationException {
		try {
<span class="fc" id="L121">			HttpPost post = new HttpPost();</span>
<span class="fc" id="L122">			String marshal = null;</span>
<span class="pc bpc" id="L123" title="1 of 2 branches missed.">			if (isXmlSignatureEnabled()) {</span>
<span class="nc" id="L124">				marshal = this.sign(payload.getValue());</span>
			} else {
<span class="fc" id="L126">				marshal = jaxbContext.marshal(payload, validateXmlPayload);</span>
			}

<span class="fc" id="L129">			StringEntity stringEntity = new StringEntity(marshal);</span>
<span class="fc" id="L130">			post.setEntity(stringEntity);</span>
<span class="fc" id="L131">			HttpResponse response = client.execute(post, host, Oadr20bUrlPath.OADR_BASE_PATH + path, context);</span>

<span class="fc bfc" id="L133" title="All 2 branches covered.">			if (response.getStatusLine().getStatusCode() != HttpStatus.SC_OK) {</span>
<span class="fc" id="L134">				EntityUtils.consumeQuietly(response.getEntity());</span>
<span class="fc" id="L135">				throw new Oadr20bHttpLayerException(response.getStatusLine().getStatusCode(),</span>
<span class="fc" id="L136">						response.getStatusLine().getReasonPhrase());</span>

			} else {
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">				if (isXmlSignatureEnabled()) {</span>
					try {
<span class="nc" id="L141">						OadrPayload unmarshal = jaxbContext.unmarshal(</span>
<span class="nc" id="L142">								EntityUtils.toString(response.getEntity(), &quot;UTF-8&quot;), OadrPayload.class,</span>
								validateXmlPayload);
<span class="nc" id="L144">						this.validate(unmarshal);</span>
<span class="nc" id="L145">						EntityUtils.consumeQuietly(response.getEntity());</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">						if (Object.class.equals(responseKlass)) {</span>
<span class="nc" id="L147">							Object signedObjectFromOadrPayload = Oadr20bFactory</span>
<span class="nc" id="L148">									.getSignedObjectFromOadrPayload(unmarshal);</span>

<span class="nc" id="L150">							return responseKlass.cast(signedObjectFromOadrPayload);</span>
						} else {
<span class="nc" id="L152">							return Oadr20bFactory.getSignedObjectFromOadrPayload(unmarshal, responseKlass);</span>
						}

<span class="nc" id="L155">					} catch (Oadr20bUnmarshalException e) {</span>
<span class="nc" id="L156">						throw new Oadr20bApplicationLayerException(&quot;Signed payload expected in response&quot;);</span>
					}
				} else {
<span class="fc" id="L159">					return jaxbContext.unmarshal(EntityUtils.toString(response.getEntity(), &quot;UTF-8&quot;), responseKlass,</span>
							validateXmlPayload);
				}
			}

<span class="nc" id="L164">		} catch (ClientProtocolException e) {</span>
<span class="nc" id="L165">			throw new Oadr20bException(&quot;http request failed&quot;, e);</span>
<span class="nc" id="L166">		} catch (IOException e) {</span>
<span class="nc" id="L167">			throw new Oadr20bException(&quot;data stream can't be read/write&quot;, e);</span>
<span class="fc" id="L168">		} catch (Oadr20bMarshalException e) {</span>
<span class="fc" id="L169">			throw new Oadr20bException(&quot;serialization failed&quot;, e);</span>
<span class="fc" id="L170">		} catch (Oadr20bUnmarshalException e) {</span>
<span class="fc" id="L171">			throw new Oadr20bException(&quot;Deserialization failed&quot;, e);</span>
<span class="nc" id="L172">		} catch (URISyntaxException e) {</span>
<span class="nc" id="L173">			throw new Oadr20bException(&quot;Host is not a valid URI&quot;, e);</span>
		}
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>